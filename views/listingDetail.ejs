<%- include('partials/head', { title: product.listing_title, bodyClass: 'bg-light' }) %>
<%- include('partials/navbar', { user, activePage: user && (user.role === 'admin' || user.role === 'coach') ? 'inventory' : 'shopping' }) %>

  <div class="container" style="max-width: 720px;">
    <div class="card">
      <div class="row g-0">
        <div class="col-md-4 text-center p-3">
          <img class="img-fluid" src="/images/<%= product.image || 'placeholder.png' %>" alt="<%= product.listing_title %>">
        </div>
        <div class="col-md-8">
    <div class="card-body">
      <h3 class="card-title"><%= product.listing_title %></h3>
      <div class="text-muted mb-2"><%= product.username %><% if (product.sport) { %> • <%= product.sport %><% } %></div>
      <% if (product.description) { %>
        <p class="card-text mb-2"><%= product.description %></p>
      <% } %>
      <% const priceNum = Number(product.price || 0); %>
      <% const discountPercentage = Math.min(100, Math.max(0, Number(product.discount_percentage) || 0)); %>
      <% const hasDiscount = discountPercentage > 0; %>
      <% const discountedPrice = hasDiscount
        ? Number((priceNum * (1 - discountPercentage / 100)).toFixed(2))
        : priceNum;
      %>
      <p class="card-text mb-1">
        <% if (hasDiscount) { %>
          <span class="text-decoration-line-through text-muted me-2">$<%= priceNum.toFixed(2) %></span>
          <span class="fw-semibold text-success">$<%= discountedPrice.toFixed(2) %></span>
        <% } else { %>
          Rate: $<%= priceNum.toFixed(2) %>
        <% } %>
      </p>
      <% if (hasDiscount) { %>
        <p class="card-text mb-2">
          <small class="text-danger">-<%= discountPercentage.toFixed(0) %>% off</small>
        </p>
      <% } %>
      <% if (product.offer_message) { %>
        <div class="card-text mb-2">
          <small class="text-info"><strong>Promo:</strong> <%= product.offer_message %></small>
        </div>
      <% } %>
      <p class="card-text mb-2">Slots: <%= product.available_slots %><% if (product.duration_minutes) { %> • <%= product.duration_minutes %> mins<% } %></p>
      <% if (typeof product.is_active !== 'undefined' && !product.is_active) { %>
        <p class="text-muted mb-3">This listing is currently hidden.</p>
      <% } %>
            <% if (user && (user.role === 'admin' || user.role === 'coach')) { %>
              <p class="mt-3"><a href="/inventory">Back to listings</a></p>
            <% } else { %>
              <form class="row g-2 align-items-end" action="/add-to-cart/<%= product.id %>" method="post">
                <div class="col-auto">
                  <label class="form-label mb-0">Slots</label>
                  <input class="form-control" type="number" name="quantity" value="1" min="1" max="<%= product.available_slots %>">
                </div>
                <div class="col-auto">
                  <button class="btn btn-primary" type="submit" <%= product.is_active ? '' : 'disabled' %>>Add to booking cart</button>
                </div>
              </form>
              <p class="mt-3"><a href="/shopping">Back to listings</a></p>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
<%- include('partials/footer') %>

