<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MatchPoint • Booking Checkout</title>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="/css/user-common.css">
  <link rel="stylesheet" href="/css/user-dashboard.css">
  <link rel="stylesheet" href="/css/admin-dashboard.css" />
</head>
<body class="admin-dashboard">
  <div class="app">

    <!-- SIDEBAR -->
    <%- include("partials/userSidebar", {
      active: "cart",
      courseCount: undefined
    }) %>

    <!-- MAIN -->
    <main class="main">
      <header class="topbar">
        <div class="crumb">BOOKING CHECKOUT</div>
        <div class="topbar__pill"><i class="fa-solid fa-check-circle"></i></div>
      </header>

      <section class="hero">
        <div class="hero__left">
          <p style="color: #666; margin: 0 0 0.5rem 0; font-size: 0.9rem;">Review & confirm</p>
          <h1 style="margin: 0 0 0.5rem 0;">Booking <span class="hero__name">summary</span></h1>
          <p style="color: #666; margin: 0; font-size: 0.95rem;">Confirm your session location and listings before completing the booking.</p>
        </div>
      </section>

      <div style="display: grid; grid-template-columns: 1fr 400px; gap: 1.5rem; margin-top: 1.5rem; max-width: 1400px;">
        <div>
          <section class="card" style="margin-bottom: 1.5rem; padding: 1.5rem;">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; font-weight: 600;">Session location</h3>
            <p style="color: #666; margin: 0;"><strong style="color: #1a1a1a;">Location:</strong> <%= deliveryAddress %></p>
          </section>

          <% const totalSavings = cart.reduce((sum, item) => {
              const basePrice = Number(item.price || 0);
              const discountPercentage = Math.min(100, Math.max(0, Number(item.discount_percentage) || 0));
              const finalPrice = discountPercentage > 0
                ? Number((basePrice * (1 - discountPercentage / 100)).toFixed(2))
                : basePrice;
              const discount = basePrice - finalPrice;
              return sum + (discount > 0 ? discount * Number(item.quantity || 0) : 0);
            }, 0);
          %>
          
          <section class="card" style="padding: 0; overflow: hidden;">
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 1rem; text-align: left; color: #6b7280; font-weight: 600; font-size: 0.85rem;">Item</th>
                    <th style="padding: 1rem; text-align: center; color: #6b7280; font-weight: 600; font-size: 0.85rem;">Image</th>
                    <th style="padding: 1rem; text-align: right; color: #6b7280; font-weight: 600; font-size: 0.85rem;">Slots</th>
                    <th style="padding: 1rem; text-align: right; color: #6b7280; font-weight: 600; font-size: 0.85rem;">Rate</th>
                  </tr>
                </thead>
                <tbody>
                  <% cart.forEach(it => {
                    const basePrice = Number(it.price || 0);
                    const qty = Number(it.quantity || 0);
                    const discountPercentage = Math.min(100, Math.max(0, Number(it.discount_percentage) || 0));
                    const hasDiscount = discountPercentage > 0;
                    const finalPrice = hasDiscount
                      ? Number((basePrice * (1 - discountPercentage / 100)).toFixed(2))
                      : basePrice;
                    const imageSrc = it.image ? '/images/' + it.image : null;
                    const sessionDateLabel = it.session_date ? new Date(it.session_date).toLocaleDateString() : 'TBC';
                    const sessionTimeLabel = it.session_time ? String(it.session_time).slice(0, 5) : 'TBC';
                  %>
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                      <td style="padding: 1.25rem;">
                        <div style="font-weight: 600; color: #1a1a1a; margin-bottom: 0.25rem;"><%= it.listing_title %></div>
                        <div style="color: #6b7280; font-size: 0.85rem; margin-bottom: 0.25rem;"><%= it.username %><% if (it.sport) { %> • <%= it.sport %><% } %></div>
                        <div style="color: #6b7280; font-size: 0.85rem;">Session: <%= sessionDateLabel %> ƒ?› <%= sessionTimeLabel %></div>
                        <% if (it.offer_message) { %>
                          <div style="color: #3b82f6; font-size: 0.85rem; margin-top: 0.25rem;"><%= it.offer_message %></div>
                        <% } %>
                      </td>
                      <td style="padding: 1.25rem; text-align: center;">
                        <% if (imageSrc) { %>
                          <img src="<%= imageSrc %>" alt="<%= it.listing_title %>" style="max-height: 60px; border-radius: 8px;">
                        <% } else { %>
                          <span style="background: #e5e7eb; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">No image</span>
                        <% } %>
                      </td>
                      <td style="padding: 1.25rem; text-align: right; font-weight: 600; font-size: 1.1rem;"><%= qty %></td>
                      <td style="padding: 1.25rem; text-align: right;">
                        <% if (hasDiscount) { %>
                          <div style="color: #9ca3af; text-decoration: line-through; font-size: 0.85rem;">$<%= basePrice.toFixed(2) %></div>
                        <% } else { %>
                          <div style="color: #6b7280; font-size: 0.85rem;">Per slot</div>
                        <% } %>
                        <div style="font-weight: 600; font-size: 1.1rem; color: #1a1a1a;">$<%= finalPrice.toFixed(2) %></div>
                        <% if (hasDiscount) { %>
                          <div style="color: #22c55e; font-size: 0.85rem;">-<%= discountPercentage.toFixed(0) %>% off</div>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </section>
        </div>

        <div>
          <section class="card" style="padding: 2rem; position: sticky; top: 2rem;">
            <p style="text-transform: uppercase; font-size: 0.75rem; color: #6b7280; margin: 0 0 0.5rem 0; font-weight: 600; letter-spacing: 0.5px;">BOOKING SUMMARY</p>
            <h2 style="margin: 0 0 1rem 0; font-size: 2rem; font-weight: 800; color: #1a1a1a;">$<%= Number(total || 0).toFixed(2) %></h2>
            <% if (totalSavings > 0) { %>
              <p style="color: #22c55e; font-size: 0.9rem; margin: 0 0 1.5rem 0;">You save $<%= totalSavings.toFixed(2) %> today</p>
            <% } else { %>
              <p style="color: #6b7280; font-size: 0.9rem; margin: 0 0 1.5rem 0;">No discounts applied.</p>
            <% } %>
            <form action="/bookingCheckout/confirm" method="post">
              <input type="hidden" name="deliveryAddress" value="<%= deliveryAddress %>">
              <button type="submit" style="width: 100%; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; padding: 1rem; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; margin-bottom: 0; transition: all 0.2s;">Confirm checkout</button>
            </form>
          </section>
          
          <section class="card" style="margin-top: 1rem; padding: 1.5rem;">
            <p style="margin: 0 0 0.75rem 0; font-weight: 500;">Need to adjust?</p>
            <a href="/bookingCart" style="display: block; width: 100%; text-align: center; background: white; color: #666; border: 2px solid #e5e7eb; padding: 0.75rem; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.2s;">Edit cart</a>
          </section>
        </div>
      </div>

    </main>
  </div>
</body>
</html>

