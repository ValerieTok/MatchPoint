<%- include('partials/head', {
  title: 'Booking Checkout',
  bodyClass: 'bg-light',
  extraHead: `<style>
    body {
      background: #f8fafc;
      min-height: 100vh;
    }
    .checkout-hero {
      background: #fff;
      color: #0f172a;
      border-radius: 26px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.1);
      border: 1px solid rgba(15, 23, 42, 0.08);
    }
    .checkout-hero small {
      color: #475569;
    }
    .item-card {
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: #fff;
      padding: 1.25rem;
    }
    .summary-card {
      border-radius: 20px;
      background: #fff;
      padding: 1.75rem;
      border: 1px solid rgba(15, 23, 42, 0.1);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }
  </style>`
}) %>
<%- include('partials/navbar', { user, activePage: 'cart' }) %>

  <div class="container py-5">
    <div class="checkout-hero text-center shadow-sm">
      <p class="mb-1">Review &amp; confirm</p>
      <h1 class="fw-bold mb-2">Booking summary</h1>
      <small>Confirm your session location and listings before completing the booking.</small>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="item-card mb-3">
          <h5 class="fw-semibold mb-3 text-dark">Session location</h5>
          <p class="text-muted mb-0"><strong class="text-dark">Location:</strong> <%= deliveryAddress %></p>
        </div>

        <% const totalSavings = cart.reduce((sum, item) => {
            const basePrice = Number(item.price || 0);
            const discountPercentage = Math.min(100, Math.max(0, Number(item.discount_percentage) || 0));
            const finalPrice = discountPercentage > 0
              ? Number((basePrice * (1 - discountPercentage / 100)).toFixed(2))
              : basePrice;
            const discount = basePrice - finalPrice;
            return sum + (discount > 0 ? discount * Number(item.quantity || 0) : 0);
          }, 0);
        %>
        <div class="item-card">
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr class="text-muted">
                  <th>Item</th>
                  <th class="text-center">Image</th>
                  <th class="text-end">Slots</th>
                  <th class="text-end">Rate</th>
                </tr>
              </thead>
              <tbody>
                <% cart.forEach(it => {
                  const basePrice = Number(it.price || 0);
                  const qty = Number(it.quantity || 0);
                  const discountPercentage = Math.min(100, Math.max(0, Number(it.discount_percentage) || 0));
                  const hasDiscount = discountPercentage > 0;
                  const finalPrice = hasDiscount
                    ? Number((basePrice * (1 - discountPercentage / 100)).toFixed(2))
                    : basePrice;
                  const imageSrc = it.image ? '/images/' + it.image : null;
                %>
                  <tr>
                    <td>
                      <div class="fw-semibold text-dark"><%= it.listing_title %></div>
                      <small class="text-muted d-block"><%= it.username %><% if (it.sport) { %> â€¢ <%= it.sport %><% } %></small>
                      <% if (it.offer_message) { %>
                        <small class="text-info"><%= it.offer_message %></small>
                      <% } %>
                    </td>
                    <td class="text-center">
                      <% if (imageSrc) { %>
                        <img src="<%= imageSrc %>" alt="<%= it.listing_title %>" class="img-fluid" style="max-height:55px;">
                      <% } else { %>
                        <span class="badge bg-secondary">No image</span>
                      <% } %>
                    </td>
                    <td class="text-end"><%= qty %></td>
                    <td class="text-end">
                      <% if (hasDiscount) { %>
                        <div class="text-decoration-line-through text-muted small">$<%= basePrice.toFixed(2) %></div>
                      <% } else { %>
                        <div class="text-muted small">Per slot</div>
                      <% } %>
                      <div class="fw-semibold">$<%= finalPrice.toFixed(2) %></div>
                      <% if (hasDiscount) { %>
                        <div class="text-success small">-<%= discountPercentage.toFixed(0) %>% off</div>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="summary-card">
          <p class="text-uppercase small mb-1">Booking summary</p>
          <h3 class="fw-semibold mb-2">$<%= Number(total || 0).toFixed(2) %></h3>
          <% if (totalSavings > 0) { %>
            <p class="text-success small mb-3">You save $<%= totalSavings.toFixed(2) %> today</p>
          <% } else { %>
            <p class="text-muted small mb-3">No discounts applied.</p>
          <% } %>
          <form action="/bookingCheckout/confirm" method="post">
            <input type="hidden" name="deliveryAddress" value="<%= deliveryAddress %>">
            <button class="btn btn-success w-100 fw-semibold" type="submit">Confirm booking</button>
          </form>
        </div>
        <div class="item-card mt-3">
          <p class="mb-1">Need to adjust?</p>
          <a class="btn btn-outline-secondary w-100" href="/bookingCart">Edit cart</a>
        </div>
      </div>
    </div>
  </div>
<%- include('partials/footer') %>



