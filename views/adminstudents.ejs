<%- include('partials/head', {
  title: 'Admin Students - MatchPoint',
  bodyClass: 'admin-page admin-students',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  `
}) %>

<div class="app">
  <%- include('partials/adminSidebar', { active: 'students' }) %>

      <main class="main">
        <header class="topbar">
          <div class="crumb">ADMIN STUDENTS</div>
          <div class="topbar__pill"><i class="fa-solid fa-user-graduate"></i></div>
        </header>

        <% const safeStats = stats || {}; %>
        <% const activeCount = Number(activeStudents || 0); %>
        <section class="hero">
          <div class="hero__left">
            <h1>
              Hello <span class="hero__name"><%= user?.username || (user?.email ? user.email.split('@')[0] : 'Admin') %></span>
              <span class="wave">ðŸ‘‹</span>,
            </h1>
            <div class="stats">
              <div class="stat">
                <div class="stat__icon"><i class="fa-solid fa-user-group"></i></div>
                <div class="stat__meta">
                  <div class="stat__label">Total Students</div>
                  <div class="stat__value"><%= (safeStats.totalStudents || 0).toLocaleString('en-US') %></div>
                </div>
              </div>
              <div class="stat">
                <div class="stat__icon"><i class="fa-solid fa-user-check"></i></div>
                <div class="stat__meta">
                  <div class="stat__label">Active Students</div>
                  <div class="stat__value"><%= activeCount.toLocaleString('en-US') %></div>
                </div>
              </div>
              <div class="stat">
                <div class="stat__icon"><i class="fa-solid fa-clipboard-check"></i></div>
                <div class="stat__meta">
                  <div class="stat__label">Completed Sessions</div>
                  <div class="stat__value"><%= (safeStats.completedSessions || 0).toLocaleString('en-US') %></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="card">
          <% const rows = Array.isArray(students) ? students : []; %>
          <% const activeFilters = filters || {}; %>
          <% const pager = pagination || { page: 1, perPage: 8, totalStudents: rows.length, totalPages: 1 }; %>
          <% const buildQuery = (pageNum) => { %>
            <% const params = []; %>
            <% if (activeFilters.search) params.push(`search=${encodeURIComponent(activeFilters.search)}`); %>
            <% if (activeFilters.sort) params.push(`sort=${encodeURIComponent(activeFilters.sort)}`); %>
            <% params.push(`page=${pageNum}`); %>
            <% return params.join('&'); %>
          <% }; %>

          <div class="card__head">
            <div class="card__title">All Students</div>
            <div class="card__tools">
              <div class="search">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input id="studentSearch" type="search" placeholder="Search" value="<%= activeFilters.search || '' %>" />
              </div>
              <div class="sort">
                <span class="sort__label">SORT BY:</span>
                <select class="sort__btn" id="studentSort">
                  <option value="newest" <%= activeFilters.sort !== 'oldest' ? 'selected' : '' %>>Newest</option>
                  <option value="oldest" <%= activeFilters.sort === 'oldest' ? 'selected' : '' %>>Oldest</option>
                </select>
              </div>
            </div>
          </div>

          <div class="tableWrap">
            <table class="table">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Join Date</th>
                  <th>Sessions</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (!rows.length) { %>
                  <tr>
                    <td colspan="5">No students found.</td>
                  </tr>
                <% } else { %>
                  <% rows.forEach(row => { %>
                    <tr>
                      <td><%= row.username %></td>
                      <td>
                        <% const joinDate = row.created_at ? new Date(row.created_at) : null; %>
                        <%= joinDate && !Number.isNaN(joinDate.getTime()) ? joinDate.toLocaleDateString('en-SG', { timeZone: 'Asia/Singapore' }) : '-' %>
                      </td>
                      <td><%= Number(row.sessions || 0).toLocaleString('en-US') %></td>
                      <td>
                        <% if (row.is_banned) { %>
                          <span class="pill pill--banned">BANNED</span>
                        <% } else { %>
                          <span class="pill pill--<%= row.status %>"><%= row.status.toUpperCase() %></span>
                        <% } %>
                      </td>
                      <td class="actions">
                        <div class="action-group">
                          <button class="btn warn js-warn" type="button" data-id="<%= row.id %>" data-name="<%= row.username %>">Issue Warning</button>
                          <% if (row.is_banned) { %>
                            <form method="post" action="/adminstudents/<%= row.id %>/unban">
                              <button class="btn neutral" type="submit">Unban User</button>
                            </form>
                          <% } else { %>
                            <button class="btn danger js-ban" type="button" data-id="<%= row.id %>" data-name="<%= row.username %>">Ban User</button>
                          <% } %>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>

          <div class="card__foot">
            <% const startIndex = pager.totalStudents ? ((pager.page - 1) * pager.perPage + 1) : 0; %>
            <% const endIndex = Math.min(pager.page * pager.perPage, pager.totalStudents || 0); %>
            <div class="hint">Showing <%= startIndex %> to <%= endIndex %> of <%= pager.totalStudents %> students</div>
            <div class="pager">
              <% if (pager.totalPages > 1) { %>
                <% if (pager.page > 1) { %>
                  <a class="pager__btn" href="/adminstudents?<%= buildQuery(pager.page - 1) %>"><i class="fa-solid fa-chevron-left"></i></a>
                <% } %>
                <% for (let p = 1; p <= pager.totalPages; p += 1) { %>
                  <a class="pager__num <%= p === pager.page ? 'pager__num--active' : '' %>" href="/adminstudents?<%= buildQuery(p) %>"><%= p %></a>
                <% } %>
                <% if (pager.page < pager.totalPages) { %>
                  <a class="pager__btn" href="/adminstudents?<%= buildQuery(pager.page + 1) %>"><i class="fa-solid fa-chevron-right"></i></a>
                <% } %>
              <% } else { %>
                <span class="pager__num pager__num--active">1</span>
              <% } %>
            </div>
          </div>
        </section>
  </main>
</div>

<div class="warn-modal" id="warnModal">
  <div class="warn-modal__backdrop" data-warn-close></div>
  <div class="warn-modal__panel" role="dialog" aria-modal="true" aria-labelledby="warnTitle">
    <h3 class="warn-modal__title" id="warnTitle">Issue Warning</h3>
    <p class="warn-modal__sub">Send a warning to <span data-warn-name>this student</span>. The comment is visible in their inbox.</p>
    <form id="warnForm" method="post">
      <div class="warn-modal__field">
        <textarea name="comment" maxlength="500" required placeholder="Add warning details..."></textarea>
      </div>
      <div class="warn-modal__actions">
        <button class="btn" type="button" data-warn-close>Cancel</button>
        <button class="btn warn" type="submit">Send Warning</button>
      </div>
    </form>
  </div>
</div>

<div class="warn-modal" id="banModal">
  <div class="warn-modal__backdrop" data-ban-close></div>
  <div class="warn-modal__panel" role="dialog" aria-modal="true" aria-labelledby="banTitle">
    <h3 class="warn-modal__title" id="banTitle">Ban Student</h3>
    <p class="warn-modal__sub">Add a reason for banning <span data-ban-name>this student</span>.</p>
    <form id="banForm" method="post">
      <div class="warn-modal__field">
        <textarea name="comment" maxlength="500" required placeholder="Add ban reason..."></textarea>
      </div>
      <div class="warn-modal__actions">
        <button class="btn" type="button" data-ban-close>Cancel</button>
        <button class="btn danger" type="submit">Ban User</button>
      </div>
    </form>
  </div>
</div>

<%- include('partials/footer', {
  extraScripts: `
    <script>
      const search = document.getElementById('studentSearch');
      const sort = document.getElementById('studentSort');
      const warnModal = document.getElementById('warnModal');
      const warnForm = document.getElementById('warnForm');
      const warnName = warnModal ? warnModal.querySelector('[data-warn-name]') : null;
      const warnComment = warnForm ? warnForm.querySelector('textarea[name="comment"]') : null;
      const warnButtons = document.querySelectorAll('.js-warn');
      const warnClosers = warnModal ? warnModal.querySelectorAll('[data-warn-close]') : [];
      const banModal = document.getElementById('banModal');
      const banForm = document.getElementById('banForm');
      const banName = banModal ? banModal.querySelector('[data-ban-name]') : null;
      const banComment = banForm ? banForm.querySelector('textarea[name="comment"]') : null;
      const banButtons = document.querySelectorAll('.js-ban');
      const banClosers = banModal ? banModal.querySelectorAll('[data-ban-close]') : [];

      const closeWarnModal = () => {
        warnModal?.classList.remove('is-open');
      };
      const closeBanModal = () => {
        banModal?.classList.remove('is-open');
      };

      warnButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const userId = btn.getAttribute('data-id');
          const userName = btn.getAttribute('data-name') || 'this student';
          if (!warnForm || !warnModal) return;
          warnForm.action = \`/adminstudents/\${userId}/warn\`;
          if (warnName) warnName.textContent = userName;
          if (warnComment) warnComment.value = '';
          warnModal.classList.add('is-open');
          warnComment?.focus();
        });
      });

      banButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const userId = btn.getAttribute('data-id');
          const userName = btn.getAttribute('data-name') || 'this student';
          if (!banForm || !banModal) return;
          banForm.action = \`/adminstudents/\${userId}/ban\`;
          if (banName) banName.textContent = userName;
          if (banComment) banComment.value = '';
          banModal.classList.add('is-open');
          banComment?.focus();
        });
      });

      warnClosers.forEach((btn) => {
        btn.addEventListener('click', closeWarnModal);
      });
      banClosers.forEach((btn) => {
        btn.addEventListener('click', closeBanModal);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeWarnModal();
          closeBanModal();
        }
      });

      const buildUrl = (params) => {
        const url = new URL(window.location.href);
        Object.keys(params).forEach((key) => {
          if (params[key]) {
            url.searchParams.set(key, params[key]);
          } else {
            url.searchParams.delete(key);
          }
        });
        return url.toString();
      };

      sort?.addEventListener('change', () => {
        window.location.href = buildUrl({ sort: sort.value, page: 1 });
      });

      search?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          const value = (search.value || '').trim().toLowerCase();
          window.location.href = buildUrl({ search: value, page: 1 });
        }
      });
    </script>
  `
}) %>
