<%- include('partials/head', {
  title: 'Update Listing',
  bodyClass: 'admin-page coach-dashboard update-listing',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  `
}) %>

<div class="app">
  <%- include("partials/coachSidebar", {
    active: "listings"
  }) %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">EDIT LISTING</div>
      <div class="topbar__pill"><i class="fa-solid fa-pen"></i></div>
    </header>

    <% if (product) { %>
      <section class="form-card mx-auto">
        <div class="form-card__head">
          <div>
            <div class="form-card__title">Update Coaching Listing</div>
            <div class="form-card__subtitle">Adjust your session details for athletes.</div>
          </div>
        </div>

        <%- include('partials/flashMessages', { messages }) %>

        <section class="card" style="margin-top: 1rem;">
          <div class="card__head">
            <div class="card__title">Availability Slots</div>
          </div>

          <form action="/updateListing/<%= product.id %>/slots" method="POST" class="form-grid" style="margin-bottom: 1.5rem;">
            <div class="form-row">
              <label for="slot_date" class="form-label">Date</label>
              <input type="date" class="form-control" id="slot_date" name="slot_date" required>
            </div>
            <div class="form-row">
              <label for="slot_time" class="form-label">Start Time</label>
              <input type="time" class="form-control" id="slot_time" name="slot_time" step="300" required>
              <small class="text-muted">Start times must align to your session duration (<%= product.duration_minutes %> mins).</small>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn--primary">Add Slot</button>
            </div>
          </form>

          <div class="tableWrap">
            <%
              const formatSlotDate = (value) => {
                if (!value) return '-';
                if (value instanceof Date && !Number.isNaN(value.getTime())) {
                  return value.toISOString().slice(0, 10);
                }
                const text = String(value);
                const match = text.match(/^(\d{4}-\d{2}-\d{2})/);
                return match ? match[1] : text;
              };
              const formatSlotTime = (value) => {
                if (!value) return '-';
                const text = value instanceof Date && !Number.isNaN(value.getTime())
                  ? value.toISOString().slice(11, 16)
                  : String(value).slice(0, 5);
                const parts = text.split(':');
                const hours = Number(parts[0]);
                const minutes = parts[1] ? parts[1].padStart(2, '0') : '00';
                if (!Number.isFinite(hours)) return text;
                const suffix = hours >= 12 ? 'PM' : 'AM';
                const displayHour = hours % 12 === 0 ? 12 : hours % 12;
                return `${displayHour}:${minutes} ${suffix}`;
              };
            %>
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Duration</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% const rows = Array.isArray(slots) ? slots : []; %>
                <% if (!rows.length) { %>
                  <tr>
                    <td colspan="5">No slots yet.</td>
                  </tr>
                <% } else { %>
                  <% rows.forEach(slot => { %>
                    <tr>
                      <td><%= formatSlotDate(slot.slot_date) %></td>
                      <td><%= formatSlotTime(slot.slot_time) %></td>
                      <td><%= slot.duration_minutes ? `${slot.duration_minutes} mins` : '-' %></td>
                      <td>
                        <% if (Number(slot.is_available) === 1) { %>
                          <span class="pill pill--upcoming">AVAILABLE</span>
                        <% } else { %>
                          <span class="pill pill--inactive">BOOKED</span>
                        <% } %>
                      </td>
                      <td class="table__actions">
                        <form action="/updateListing/<%= product.id %>/slots/<%= slot.id %>/delete" method="POST" onsubmit="return confirm('Delete this slot?');">
                          <button type="submit" class="btn btn--ghost btn--sm btn--danger"><i class="fa-solid fa-trash"></i> Delete</button>
                        </form>
                      </td>
                    </tr>
                  <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>
        </section>

        <form action="/updateListing/<%= product.id %>" method="POST" enctype="multipart/form-data" class="form-grid">
          <div class="form-row">
            <label for="listing_title" class="form-label">Sport Type</label>
            <input type="text" class="form-control" id="listing_title" name="listing_title" value="<%= product.listing_title %>" required>
          </div>

          <div class="form-row">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required><%= product.description || '' %></textarea>
          </div>

          <div class="form-row">
            <label for="skill_level" class="form-label">Skill Level</label>
            <select class="form-select" id="skill_level" name="skill_level" required>
              <option value="beginner" <%= (product.skill_level || 'beginner') === 'beginner' ? 'selected' : '' %>>Beginner</option>
              <option value="intermediate" <%= (product.skill_level || 'beginner') === 'intermediate' ? 'selected' : '' %>>Intermediate</option>
              <option value="advanced" <%= (product.skill_level || 'beginner') === 'advanced' ? 'selected' : '' %>>Advanced</option>
              <option value="expert" <%= (product.skill_level || 'beginner') === 'expert' ? 'selected' : '' %>>Expert</option>
            </select>
          </div>

          <div class="form-row">
            <label for="price" class="form-label">Price per Session</label>
            <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" value="<%= typeof product.price !== 'undefined' ? product.price : '' %>" required>
          </div>

          <div class="form-row">
            <label for="is_active" class="form-label">Listing Status</label>
            <select class="form-select" id="is_active" name="is_active" required>
              <option value="1" <%= product.is_active ? 'selected' : '' %>>Active</option>
              <option value="0" <%= product.is_active ? '' : 'selected' %>>Inactive</option>
            </select>
          </div>

          <div class="form-row">
            <label for="session_location" class="form-label">Location</label>
            <input type="text" class="form-control" id="session_location" name="session_location" value="<%= product.session_location || '' %>" required>
          </div>

          <div class="form-row">
            <label class="form-label">Current Image</label>
            <input type="text" class="form-control" name="current_image" value="<%= product.image || '' %>" readonly>
            <% if (product.image) { %>
              <img src="/images/<%= product.image %>" class="img-thumbnail mt-2" style="width: 150px;">
            <% } %>
          </div>

          <div class="form-row">
            <label for="image" class="form-label">Upload New Image</label>
            <input class="form-control" type="file" id="image" name="image" accept="image/*">
            <img id="newImagePreview" class="img-thumbnail mt-2 d-none" style="width: 150px;" alt="New listing preview">
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn--primary">Update Listing</button>
            <a href="/listingsManage" class="btn btn--ghost">Back to Listings</a>
          </div>
        </form>
      </section>
    <% } else { %>
      <p class="text-center">No listing found.</p>
    <% } %>
  </main>
</div>

<script>
  (function () {
    const imageInput = document.getElementById('image');
    const preview = document.getElementById('newImagePreview');
    if (!imageInput || !preview) return;
    imageInput.addEventListener('change', () => {
      const file = imageInput.files && imageInput.files[0];
      if (!file) {
        preview.src = '';
        preview.classList.add('d-none');
        return;
      }
      if (!file.type || !file.type.startsWith('image/')) {
        preview.src = '';
        preview.classList.add('d-none');
        return;
      }
      const reader = new FileReader();
      reader.onload = (event) => {
        preview.src = event.target.result;
        preview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);
    });
  })();
</script>

<%- include('partials/footer') %>
