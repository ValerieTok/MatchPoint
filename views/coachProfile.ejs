<%- include('partials/head', {
  title: 'Coach Profile',
  bodyClass: 'admin-page coach-dashboard',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  `
}) %>

<%
  const displayName = profile && profile.full_name ? profile.full_name : (profile && profile.username ? profile.username : '');
  const certFile = profile && profile.coach_cert_file ? `/certifications/${profile.coach_cert_file}` : null;
%>

<div class="app">
  <%- include("partials/coachSidebar", {
    active: "profile"
  }) %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">PROFILE</div>
      <div class="topbar__pill"><i class="fa-solid fa-user"></i></div>
    </header>

    <section class="profile-hero">
      <div>
        <h1>Hello Coach! <span class="hero__name"><%= displayName %></span></h1>
        <p>Manage your profile details and certifications.</p>
      </div>
    </section>

    <%- include('partials/flashMessages', { messages }) %>

    <section class="profile-grid">
      <div class="profile-card profile-card--wide">
        <div class="profile-card__head">
          <div class="profile-card__title">Profile Photo</div>
          <div class="profile-card__subtitle">Upload a JPG, PNG, or WEBP under 2MB.</div>
        </div>
        <div class="profile-photo">
          <% if (profilePhoto) { %>
            <img src="/images/<%= profilePhoto %>" alt="Profile photo">
          <% } else { %>
            <div class="profile-photo__placeholder">
              <i class="fa-solid fa-user"></i>
            </div>
          <% } %>
          <form action="/coachProfile/photo" method="post" enctype="multipart/form-data" class="profile-photo__form">
            <label class="file-label" for="photo">
              <i class="fa-solid fa-arrow-up-from-bracket"></i>
              Upload Photo
            </label>
            <input type="file" id="photo" name="photo" accept=".jpg,.jpeg,.png,.webp,.gif">
            <button class="btn btn--primary" type="submit">Save Photo</button>
          </form>
        </div>
      </div>
      <div class="profile-card">
        <div class="profile-card__head">
          <div class="profile-card__title">Coach Details</div>
          <div class="profile-card__subtitle">Update your personal information.</div>
        </div>

        <form action="/coachProfile" method="post" class="profile-form">
          <div class="profile-field">
            <label for="full_name">Full name</label>
            <input type="text" id="full_name" name="full_name" value="<%= profile.full_name || '' %>" required>
          </div>
          <div class="profile-field">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" value="<%= profile.email || '' %>" required>
          </div>
          <div class="profile-field">
            <label for="contact">Phone number</label>
            <input type="text" id="contact" name="contact" value="<%= profile.contact || '' %>">
          </div>
          <div class="profile-actions">
            <button class="btn btn--primary" type="submit">Save changes</button>
          </div>
        </form>
      </div>

      <div class="profile-card">
        <div class="profile-card__head">
          <div class="profile-card__title">Reset Password</div>
          <div class="profile-card__subtitle">Use a strong password.</div>
        </div>

        <form action="/coachProfile/password" method="post" class="profile-form">
          <div class="profile-field">
            <label for="current_password">Current password</label>
            <input type="password" id="current_password" name="current_password" required>
          </div>
          <div class="profile-field">
            <label for="new_password">New password</label>
            <input type="password" id="new_password" name="new_password" minlength="8" required>
          </div>
          <div class="profile-field">
            <label for="confirm_password">Confirm new password</label>
            <input type="password" id="confirm_password" name="confirm_password" minlength="8" required>
          </div>
          <div class="profile-field">
            <label>
              <input type="checkbox" data-show-password-target="#current_password, #new_password, #confirm_password">
              Show passwords
            </label>
          </div>
          <div class="profile-actions">
            <button class="btn btn--primary" type="submit">Reset password</button>
          </div>
        </form>
      </div>

      <div class="profile-card profile-card--wide">
        <div class="profile-card__head">
          <div class="profile-card__title">Sports Certification</div>
          <div class="profile-card__subtitle">Upload your latest certification.</div>
        </div>

        <form action="/coachProfile/certification" method="post" enctype="multipart/form-data" class="profile-form">
          <div class="profile-field">
            <label for="cert_title">Certification title</label>
            <input type="text" id="cert_title" name="cert_title" value="<%= profile.coach_cert_title || '' %>" required>
          </div>
          <div class="profile-field">
            <label for="cert_file">Upload certification photo</label>
            <input type="file" id="cert_file" name="cert_file" accept=".jpg,.jpeg,.png,.webp,.gif" required>
          </div>
          <% if (certFile) { %>
            <div class="cert-preview">
              <div class="cert-preview__label">Current certification</div>
              <button type="button" class="cert-preview__thumb" data-cert-open>
                <img src="<%= certFile %>" alt="Coach certification">
              </button>
              <div class="cert-preview__hint">Click to zoom</div>
            </div>
          <% } %>
          <div class="profile-actions">
            <button class="btn btn--primary" type="submit">Submit certification</button>
          </div>
        </form>
      </div>
    </section>
    <% if (certFile) { %>
      <div class="cert-modal" data-cert-modal>
        <div class="cert-modal__backdrop" data-cert-close></div>
        <div class="cert-modal__content">
          <button type="button" class="cert-modal__close" data-cert-close aria-label="Close certificate preview">
            <i class="fa-solid fa-xmark"></i>
          </button>
          <img src="<%= certFile %>" alt="Coach certification">
        </div>
      </div>
    <% } %>
  </main>
</div>

<%- include('partials/showPasswordToggle') %>
<% if (certFile) { %>
<script>
  (function () {
    const openBtn = document.querySelector('[data-cert-open]');
    const modal = document.querySelector('[data-cert-modal]');
    if (!openBtn || !modal) return;
    const closeTargets = modal.querySelectorAll('[data-cert-close]');
    openBtn.addEventListener('click', () => modal.classList.add('is-open'));
    closeTargets.forEach((btn) => {
      btn.addEventListener('click', () => modal.classList.remove('is-open'));
    });
  })();
</script>
<% } %>
<%- include('partials/footer') %>
