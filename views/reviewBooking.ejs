<%- include('partials/head', { title: 'Review Booking', bodyClass: 'bg-light' }) %>
<%- include('partials/navbar', { user, activePage: 'orderUser' }) %>

  <div class="container py-4">
    <div class="bg-white rounded-4 shadow-sm p-4 mb-3">
      <h3 class="mb-1">Leave a review for Booking #<%= order.id %></h3>
      <p class="text-muted mb-0">Session completed at <%= new Date(order.completed_at).toLocaleString() %></p>
    </div>
    <div class="bg-white rounded-4 shadow-sm p-4 mb-4">
      <h5 class="mb-3">Booking summary</h5>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="text-muted small">
            <tr>
              <th>Listing</th>
              <th class="text-center">Image</th>
              <th class="text-end">Slots</th>
              <th class="text-end">Rate</th>
              <th class="text-end">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <% order.items.forEach(it => {
              const price = Number(it.price || 0);
              const qty = Number(it.quantity || 0);
              const listPrice = Number(it.listPrice || it.originalPrice || price);
              const discountApplied = listPrice > price;
              const subtotal = price * qty;
              const sessionDateLabel = it.session_date ? new Date(it.session_date).toLocaleDateString() : 'TBC';
              const sessionTimeLabel = it.session_time ? String(it.session_time).slice(0, 5) : 'TBC';
            %>
              <tr>
                <td>
                  <div class="fw-semibold text-dark"><%= it.listing_title %></div>
                  <div class="text-muted small"><%= it.username %><% if (it.sport) { %> • <%= it.sport %><% } %></div>
                  <div class="text-muted small">Session: <%= sessionDateLabel %> ƒ?› <%= sessionTimeLabel %></div>
                  <% if (it.offerMessage) { %>
                    <div class="text-info small"><%= it.offerMessage %></div>
                  <% } %>
                </td>
                <td class="text-center">
                  <% if (it.image) { %>
                    <img src="/images/<%= it.image %>" alt="<%= it.listing_title %>" class="img-fluid" style="max-height:60px;">
                  <% } else { %>
                    <span class="text-muted small">No image</span>
                  <% } %>
                </td>
                <td class="text-end"><%= qty %></td>
                <td class="text-end">
                  <% if (discountApplied) { %>
                    <div class="text-decoration-line-through text-muted small">$<%= listPrice.toFixed(2) %></div>
                    <div class="text-success small">-<%= Math.round(((listPrice - price) / listPrice) * 100) %>% off</div>
                  <% } %>
                  <div class="fw-semibold">$<%= price.toFixed(2) %></div>
                </td>
                <td class="text-end fw-semibold">$<%= subtotal.toFixed(2) %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
    <div class="bg-white rounded-4 shadow-sm p-4">
      <form action="/reviewBooking/<%= order.id %>/review" method="post">
        <div class="mb-3">
          <label class="form-label fw-semibold">Rating</label>
          <select class="form-select" name="rating" required>
            <option value="">Select rating</option>
            <% for(let i=5; i>=1; i--) { %>
              <option value="<%= i %>"><%= i %> star<%= i > 1 ? 's' : '' %></option>
            <% } %>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">Comments</label>
          <textarea class="form-control" name="comment" rows="4" placeholder="Share your experience"></textarea>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-secondary" href="/bookingsUser">Back to bookings</a>
          <button class="btn btn-success" type="submit">Submit review</button>
        </div>
      </form>
    </div>
  </div>
<%- include('partials/footer') %>

