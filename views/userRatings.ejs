<%- include('partials/head', {
  title: 'Ratings',
  bodyClass: 'admin-page admin-dashboard user-dashboard',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  `
}) %>

<div class="app">
  <%- include("partials/userSidebar", {
    active: "ratings",
    courseCount: undefined
  }) %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">USER RATINGS PAGE</div>
    </header>

    <section class="card">
      <div class="card__head">
        <div class="card__title">Completed Sessions</div>
        <div class="cell-sub">Completed sessions only. Leave a review after a session; admin approval is required before coaches can see it.</div>
      </div>

      <%- include('partials/flashMessages', { messages }) %>

      <div class="tableWrap">
        <table class="table" id="completedTable">
          <thead>
            <tr>
              <th>Coach Name</th>
              <th>Date &amp; Time</th>
              <th>Sport</th>
              <th>Location</th>
              <th>Rating</th>
              <th>Review</th>
              <th>Refund</th>
            </tr>
          </thead>

          <tbody>
            <%
              const completedRows = Array.isArray(completedSessions) ? completedSessions : [];
              const formatMoney = (value) => Number(value || 0).toFixed(2);
            %>

            <% if (!completedRows.length) { %>
              <tr>
                <td colspan="7">No completed sessions yet.</td>
              </tr>
            <% } else { %>
              <% completedRows.forEach(r => { %>
                <tr>
                  <td>
                    <div><%= r.coach || '-' %></div>
                    <% if (r.sport) { %>
                      <div class="cell-sub"><%= r.sport %></div>
                    <% } %>
                  </td>
                  <td>
                    <% const dateLabel = sessionDateHelper.formatSessionDate(r.date); %>
                    <% const timeLabel = sessionDateHelper.formatSessionTime(r.time); %>
                    <%= timeLabel ? `${dateLabel} ${timeLabel}` : dateLabel %>
                  </td>
                  <td><%= r.sport || '-' %></td>
                  <td><%= r.location || '-' %></td>
                  <td>
                    <% const rating = r.review && r.review.rating ? r.review.rating : 0; %>
                    <% if (rating) { %>
                      <span class="pill pill--review"><%= rating %>/5</span>
                    <% } else { %>
                      <span class="cell-sub">No rating</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (r.review) { %>
                      <span class="cell-sub"><%= r.review.comment || 'No comment.' %></span>
                      <div class="cell-sub">
                        Review approval:
                        <% const rawStatus = r.review.review_status || 'pending'; %>
                        <% const approvalStatus = rawStatus === 'completed' ? 'approved' : rawStatus; %>
                        <span class="pill pill--<%= approvalStatus %>">
                          <%= String(approvalStatus).toUpperCase() %>
                        </span>
                      </div>
                    <% } else { %>
                      <span class="cell-sub">No review yet.</span>
                      <a class="btn btn--primary btn--sm btn--review" href="/feedback?booking_id=<%= r.bookingId %>">
                        Leave Review
                      </a>
                    <% } %>
                  </td>
                  <td>
                    <% const itemTotal = Number(r.price || 0) * Number(r.quantity || 0); %>
                    <% const refund = r.refund || null; %>
                    <% const refundStatus = refund ? String(refund.status || '').toLowerCase() : ''; %>
                    <% if (refund && refundStatus === 'approved') { %>
                      <span class="pill pill--approved">APPROVED</span>
                      <div class="cell-sub">+$<%= formatMoney(refund.approved_amount || itemTotal) %> credited</div>
                    <% } else if (refund && refundStatus === 'pending') { %>
                      <span class="pill pill--pending">PENDING APPROVAL</span>
                      <div class="cell-sub"><%= refund.reason || 'Refund requested.' %></div>
                    <% } else { %>
                      <% if (refund && refundStatus === 'rejected') { %>
                        <span class="pill pill--rejected">REJECTED</span>
                        <div class="cell-sub">You can request again.</div>
                      <% } %>
                      <form class="refund-form" method="post" action="/refunds/request">
                        <input type="hidden" name="bookingId" value="<%= r.bookingId %>">
                        <input type="hidden" name="bookingItemId" value="<%= r.itemId %>">
                        <div class="cell-sub">Refund amount: $<%= formatMoney(itemTotal) %></div>
                        <textarea name="reason" rows="2" placeholder="Reason for refund" required></textarea>
                        <button class="btn btn--primary btn--sm" type="submit">Request Refund</button>
                      </form>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<%- include('partials/footer') %>
