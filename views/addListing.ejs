<%- include('partials/head', {
  title: 'Add Listing',
  bodyClass: 'admin-page coach-dashboard add-listing',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  `
}) %>

<div class="app">
  <%- include("partials/coachSidebar", {
    active: "add"
  }) %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">ADD LISTING</div>
      <div class="topbar__pill"><i class="fa-solid fa-plus"></i></div>
    </header>

    <section class="form-card mx-auto">
      <div class="form-card__head">
        <div>
          <div class="form-card__title">Add Coaching Listing</div>
          <div class="form-card__subtitle">Create a new session for athletes to book.</div>
        </div>
      </div>

      <%- include('partials/flashMessages', { messages }) %>

      <form action="/addListing" method="POST" enctype="multipart/form-data" class="form-grid">
        <div class="form-row">
          <label for="listing_title" class="form-label">Sport Type</label>
          <input type="text" class="form-control" id="listing_title" name="listing_title" placeholder="e.g. Tennis, Football" required>
        </div>

        <div class="form-row">
          <label for="description" class="form-label">Description</label>
          <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe the coaching focus and goals" required></textarea>
        </div>

        <div class="form-row">
          <label for="skill_level" class="form-label">Skill Level</label>
          <select class="form-select" id="skill_level" name="skill_level" required>
            <option value="" disabled selected>Select level</option>
            <option value="beginner">Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
            <option value="expert">Expert</option>
          </select>
        </div>

        <section class="card" style="margin-top: 1rem;">
          <div class="card__head">
            <div class="card__title">Availability Slots</div>
          </div>

          <div class="form-grid" style="margin-bottom: 1rem;">
            <div class="form-row">
              <label class="form-label">Date</label>
              <input type="date" class="form-control" id="slotDateInput">
            </div>
            <div class="form-row">
              <label class="form-label">Start Time</label>
              <input type="time" class="form-control" id="slotTimeInput" step="300">
            </div>
            <div class="form-row">
              <label class="form-label">Actions</label>
              <button type="button" class="btn btn--primary" id="addSlotRow">Add Slot</button>
            </div>
          </div>

          <div id="slotList" class="tableWrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="slotListBody">
                <tr>
                  <td colspan="3">No slots added yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <div class="form-row">
          <label for="price" class="form-label">Price per Session</label>
          <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" placeholder="e.g. 50.00" required>
        </div>

        <div class="form-row">
          <label for="is_active" class="form-label">Listing Status</label>
          <select class="form-select" id="is_active" name="is_active" required>
            <option value="1" selected>Active</option>
            <option value="0">Inactive</option>
          </select>
        </div>

        <div class="form-row">
          <label for="session_location" class="form-label">Location</label>
          <input type="text" class="form-control" id="session_location" name="session_location" placeholder="e.g. RP Sports Hall / Zoom" required>
        </div>

        <div class="form-row">
          <label for="image" class="form-label">Listing Image</label>
          <input class="form-control" type="file" id="image" name="image" accept="image/*">
        </div>

        <% if (user && user.role === 'admin') { %>
        <div class="form-row">
          <label for="coach_id" class="form-label">Coach User ID</label>
          <input type="number" class="form-control" id="coach_id" name="coach_id" min="1" step="1" placeholder="Assign listing to a coach">
        </div>
        <% } %>

        <div class="form-actions">
          <button type="submit" class="btn btn--primary">Add Listing</button>
          <a href="/listingsManage" class="btn btn--ghost">Back to Listings</a>
        </div>
      </form>
    </section>
  </main>
</div>

<script>
  (function () {
    const dateInput = document.getElementById('slotDateInput');
    const timeInput = document.getElementById('slotTimeInput');
    const addBtn = document.getElementById('addSlotRow');
    const listBody = document.getElementById('slotListBody');
    if (!dateInput || !timeInput || !addBtn || !listBody) return;

    const renderEmpty = () => {
      if (listBody.children.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="3">No slots added yet.</td>';
        listBody.appendChild(row);
      }
    };

    const clearEmpty = () => {
      const first = listBody.querySelector('tr');
      if (first && first.children.length === 1) {
        listBody.innerHTML = '';
      }
    };

    const formatTime = (timeValue) => {
      if (!timeValue) return '';
      const parts = String(timeValue).split(':');
      const hours = Number(parts[0]);
      const minutes = parts[1] ? parts[1].padStart(2, '0') : '00';
      if (!Number.isFinite(hours)) return timeValue;
      const suffix = hours >= 12 ? 'PM' : 'AM';
      const displayHour = hours % 12 === 0 ? 12 : hours % 12;
      return `${displayHour}:${minutes} ${suffix}`;
    };

    const addSlotRow = (dateValue, timeValue) => {
      const displayTime = formatTime(timeValue);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${dateValue}</td>
        <td>${displayTime}</td>
        <td>
          <button type="button" class="btn btn--ghost btn--sm btn--danger" data-slot-remove>Remove</button>
          <input type="hidden" name="slot_date[]" value="${dateValue}">
          <input type="hidden" name="slot_time[]" value="${timeValue}">
        </td>
      `;
      listBody.appendChild(row);
    };

    addBtn.addEventListener('click', () => {
      const dateValue = dateInput.value;
      const timeValue = timeInput.value;
      if (!dateValue || !timeValue) {
        return;
      }
      clearEmpty();
      addSlotRow(dateValue, timeValue);
      dateInput.value = '';
      timeInput.value = '';
    });

    listBody.addEventListener('click', (event) => {
      const target = event.target;
      if (!target || !target.matches('[data-slot-remove]')) return;
      const row = target.closest('tr');
      if (row) row.remove();
      renderEmpty();
    });
  })();
</script>

<%- include('partials/footer') %>
