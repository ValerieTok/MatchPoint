<%- include('partials/head', {
  title: 'Checkout',
  bodyClass: 'bg-light',
  extraHead: `<style>
    body {
      background: #f8fafc;
      min-height: 100vh;
    }
    .checkout-hero {
      background: #fff;
      color: #0f172a;
      border-radius: 26px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.1);
      border: 1px solid rgba(15, 23, 42, 0.08);
    }
    .checkout-hero small {
      color: #475569;
    }
    .item-card {
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: #fff;
      padding: 1.25rem;
    }
    .summary-card {
      border-radius: 20px;
      background: #fff;
      padding: 1.75rem;
      border: 1px solid rgba(15, 23, 42, 0.1);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }
  </style>`
}) %>
<%- include('partials/navbar', { user, activePage: 'cart' }) %>

  <div class="container py-5">
    <div class="checkout-hero text-center shadow-sm">
      <p class="mb-1">Review &amp; confirm</p>
      <h1 class="fw-bold mb-2">Checkout summary</h1>
      <small>Ensure your delivery location and items are correct before completing the purchase.</small>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="item-card mb-3">
          <h5 class="fw-semibold mb-3 text-dark">Delivery location</h5>
          <p class="text-muted mb-0"><strong class="text-dark">Address:</strong> <%= deliveryAddress %></p>
        </div>

        <% const totalSavings = cart.reduce((sum, item) => {
            const original = Number(item.originalPrice || item.listPrice || item.price || 0);
            const discount = original - Number(item.price || 0);
            return sum + (discount > 0 ? discount * Number(item.quantity || 0) : 0);
          }, 0);
        %>
        <div class="item-card">
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr class="text-muted">
                  <th>Item</th>
                  <th class="text-center">Image</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Price</th>
                </tr>
              </thead>
              <tbody>
                <% cart.forEach(it => {
                  const price = Number(it.price || 0);
                  const qty = Number(it.quantity || 0);
                  const listPrice = Number(it.listPrice || price);
                  const discountPercentage = Number(it.discountPercentage || 0);
                  const hasDiscount = discountPercentage > 0 && listPrice > price;
                  const imageSrc = it.image ? '/images/' + it.image : null;
                %>
                  <tr>
                    <td>
                      <div class="fw-semibold text-dark"><%= it.productName %></div>
                      <% if (it.offerMessage) { %>
                        <small class="text-info"><%= it.offerMessage %></small>
                      <% } %>
                    </td>
                    <td class="text-center">
                      <% if (imageSrc) { %>
                        <img src="<%= imageSrc %>" alt="<%= it.productName %>" class="img-fluid" style="max-height:55px;">
                      <% } else { %>
                        <span class="badge bg-secondary">No image</span>
                      <% } %>
                    </td>
                    <td class="text-end"><%= qty %></td>
                    <td class="text-end">
                      <% const original = Number(it.originalPrice || listPrice || price); %>
                      <% if (original > price) { %>
                        <div class="text-decoration-line-through text-muted small">$<%= original.toFixed(2) %></div>
                      <% } else { %>
                        <div class="text-muted small">Unit</div>
                      <% } %>
                      <div class="fw-semibold">$<%= price.toFixed(2) %></div>
                      <% if (original > price) { %>
                        <div class="text-success small">-<%= ((1 - price / original) * 100).toFixed(0) %>% off</div>
                      <% } else if (hasDiscount) { %>
                        <div class="text-success small">-<%= discountPercentage.toFixed(0) %>% off</div>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="summary-card">
          <p class="text-uppercase small mb-1">Order summary</p>
          <h3 class="fw-semibold mb-2">$<%= Number(total || 0).toFixed(2) %></h3>
          <% if (totalSavings > 0) { %>
            <p class="text-success small mb-3">You save $<%= totalSavings.toFixed(2) %> today</p>
          <% } else { %>
            <p class="text-muted small mb-3">No discounts applied.</p>
          <% } %>
          <form action="/checkout/confirm" method="post">
            <input type="hidden" name="deliveryAddress" value="<%= deliveryAddress %>">
            <button class="btn btn-success w-100 fw-semibold" type="submit">Confirm purchase</button>
          </form>
        </div>
        <div class="item-card mt-3">
          <p class="mb-1">Need to adjust?</p>
          <a class="btn btn-outline-secondary w-100" href="/cart">Edit cart</a>
        </div>
      </div>
    </div>
  </div>
<%- include('partials/footer') %>
