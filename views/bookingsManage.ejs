<% const bodyClass = user && user.role === 'admin' ? 'admin-page admin-dashboard' : 'admin-page coach-dashboard'; %>
<%- include('partials/head', {
  title: 'Bookings',
  bodyClass: bodyClass,
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  `
}) %>

<%
  const safeSearchTerm = typeof searchTerm !== 'undefined' ? searchTerm : '';
  const activeStatus = typeof statusFilter !== 'undefined' ? statusFilter : 'all';
  const isAdmin = user && user.role === 'admin';
  const isCoach = user && user.role === 'coach';
  const resolveStatus = (order) => {
    if (order && order.completed_at) return { label: 'CONFIRMED', class: 'pill--review' };
    if (isAdmin) return { label: 'UNCONFIRMED', class: 'pill--pending' };
    const normalized = order ? String(order.status || '').toLowerCase() : '';
    if (normalized === 'rejected') return { label: 'UNCONFIRMED', class: 'pill--inactive' };
    if (normalized === 'accepted') return { label: 'CONFIRMED', class: 'pill--review' };
    return { label: 'UNCONFIRMED', class: 'pill--pending' };
  };
%>
<div class="app">
  <% if (user && user.role === 'admin') { %>
    <%- include("partials/adminSidebar", { active: "bookings" }) %>
  <% } else { %>
    <%- include("partials/coachSidebar", { active: "bookings" }) %>
  <% } %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">BOOKINGS</div>
      <div class="topbar__pill"><i class="fa-solid fa-calendar-check"></i></div>
    </header>

    <section class="card">
      <div class="card__head">
        <div class="card__title">All Sessions</div>
        <form class="card__tools" method="get" action="/bookingsManage">
          <div class="search">
            <label class="sort__label" for="order-search">SEARCH</label>
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="order-search" name="search" type="search" placeholder="Booked by or sport type" value="<%= safeSearchTerm %>">
          </div>
          <div class="sort">
            <span class="sort__label">STATUS:</span>
            <select class="sort__btn" id="statusFilter" name="status">
              <option value="all" <%= activeStatus === 'all' ? 'selected' : '' %>><%= isAdmin ? 'All' : 'Active' %></option>
              <option value="completed" <%= activeStatus === 'completed' ? 'selected' : '' %>>Completed</option>
            </select>
          </div>
        </form>
      </div>

      <%- include('partials/flashMessages', { messages }) %>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>Booked By</th>
              <th>Booked At</th>
              <th>Coach Name</th>
              <th>Date &amp; Time</th>
              <th>Phone Number</th>
              <th>Email</th>
              <th>Sport</th>
              <th>Location</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% const rows = Array.isArray(orders) ? orders : []; %>
            <% if (!rows.length) { %>
              <tr>
                <td colspan="10">No bookings found.</td>
              </tr>
            <% } else { %>
              <% rows.forEach(o => { %>
                <% const statusMeta = resolveStatus(o); %>
                <% const bookedAt = sessionDateHelper.formatSgDateTime(o.created_at); %>
                <% const bookedBy = o.username || '-'; %>
                <% const bookedEmail = o.user_email || '-'; %>
                <% const bookedPhone = o.user_contact || '-'; %>
                <% const items = Array.isArray(o.items) && o.items.length ? o.items : [null]; %>
                <% items.forEach(it => { %>
                  <% const coachName = it && it.username ? it.username : '-'; %>
                  <% const sportName = it && (it.sport || it.listing_title) ? (it.sport || it.listing_title) : '-'; %>
                  <% const location = it && it.session_location ? it.session_location : (o.session_location || '-'); %>
                  <% const dateLabel = it ? sessionDateHelper.formatSessionDate(it.session_date) : 'TBC'; %>
                  <% const timeLabel = it ? sessionDateHelper.formatSessionTime(it.session_time) : ''; %>
                  <tr>
                    <td><%= bookedBy %></td>
                    <td><%= bookedAt %></td>
                    <td>
                      <div><%= coachName %></div>
                      <% if (sportName && it && it.sport) { %>
                        <div class="cell-sub"><%= it.sport %></div>
                      <% } %>
                    </td>
                    <td><%= timeLabel ? `${dateLabel} ${timeLabel}` : dateLabel %></td>
                    <td><%= bookedPhone %></td>
                    <td><%= bookedEmail %></td>
                    <td><%= sportName %></td>
                    <td><%= location %></td>
                    <td>
                      <span class="pill <%= statusMeta.class %>"><%= statusMeta.label %></span>
                    </td>
                    <td>
                      <% if (isAdmin) { %>
                        <a class="btn btn--ghost btn--sm" href="/bookingsManage/<%= o.id %>">View Details</a>
                      <% } else if (isCoach && !o.completed_at) { %>
                        <form style="display:inline-block;" action="/bookingsManage/<%= o.id %>/confirm-complete" method="post">
                          <button class="btn btn--primary btn--sm" type="submit">Mark Complete</button>
                        </form>
                      <% } else { %>
                        <span class="cell-sub">Locked</span>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>

      <div class="card__foot">
        <% const pager = pagination || { page: 1, perPage: 10, totalOrders: 0, totalPages: 1 }; %>
        <% const startIndex = pager.totalOrders ? ((pager.page - 1) * pager.perPage + 1) : 0; %>
        <% const endIndex = Math.min(pager.page * pager.perPage, pager.totalOrders || 0); %>
        <div class="hint">Showing <%= startIndex %> to <%= endIndex %> of <%= pager.totalOrders %> bookings</div>

        <div class="pager">
          <% const buildQuery = (pageNum) => { %>
            <% const params = []; %>
            <% if (safeSearchTerm) params.push(`search=${encodeURIComponent(safeSearchTerm)}`); %>
            <% if (activeStatus) params.push(`status=${encodeURIComponent(activeStatus)}`); %>
            <% params.push(`page=${pageNum}`); %>
            <% return params.join('&'); %>
          <% }; %>
          <% if (pager.totalPages > 1) { %>
            <% if (pager.page > 1) { %>
              <a class="pager__btn" href="/bookingsManage?<%= buildQuery(pager.page - 1) %>"><i class="fa-solid fa-chevron-left"></i></a>
            <% } %>
            <% for (let p = 1; p <= pager.totalPages; p += 1) { %>
              <a class="pager__num <%= p === pager.page ? 'pager__num--active' : '' %>" href="/bookingsManage?<%= buildQuery(p) %>"><%= p %></a>
            <% } %>
            <% if (pager.page < pager.totalPages) { %>
              <a class="pager__btn" href="/bookingsManage?<%= buildQuery(pager.page + 1) %>"><i class="fa-solid fa-chevron-right"></i></a>
            <% } %>
          <% } else { %>
            <span class="pager__num pager__num--active">1</span>
          <% } %>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  const statusFilter = document.getElementById('statusFilter');
  statusFilter?.addEventListener('change', () => {
    statusFilter.form?.submit();
  });
</script>

<%- include('partials/footer') %>
