<%- include('partials/head', {
  title: 'Bookings',
  bodyClass: 'admin-page coach-dashboard',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  `
}) %>

<%
  const safeSearchTerm = typeof searchTerm !== 'undefined' ? searchTerm : '';
  const activeStatus = typeof statusFilter !== 'undefined' ? statusFilter : 'all';
  const parseDbDateAsUtc = (value) => {
    if (!value) return null;
    if (value instanceof Date && !Number.isNaN(value.getTime())) return value;
    const raw = String(value).trim();
    if (!raw) return null;
    if (/[zZ]$|[+-]\d{2}:?\d{2}$/.test(raw)) return new Date(raw);
    if (/^\d{4}-\d{2}-\d{2} /.test(raw)) return new Date(raw.replace(' ', 'T'));
    if (/^\d{4}-\d{2}-\d{2}T/.test(raw)) return new Date(raw);
    return new Date(raw);
  };
  const formatSgDateTime = (value) => {
    const date = parseDbDateAsUtc(value);
    if (!date || Number.isNaN(date.getTime())) return 'TBC';
    return date.toLocaleString('en-SG', { timeZone: 'Asia/Singapore' });
  };
  const toIsoDate = (value) => {
    if (!value) return '';
    if (value instanceof Date && !Number.isNaN(value.getTime())) {
      return value.toISOString().slice(0, 10);
    }
    const raw = String(value).trim();
    if (!raw) return '';
    if (/^\d{4}-\d{2}-\d{2}/.test(raw)) return raw.slice(0, 10);
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) {
      const [day, month, year] = raw.split('/');
      return `${year}-${month}-${day}`;
    }
    return '';
  };
  const formatSessionDate = (value) => {
    const iso = toIsoDate(value);
    if (!iso) return 'TBC';
    const date = new Date(`${iso}T00:00:00+08:00`);
    if (Number.isNaN(date.getTime())) return 'TBC';
    return date.toLocaleDateString('en-SG');
  };
  const formatSessionTime = (value) => (value ? String(value).slice(0, 5) : 'TBC');
  const resolveStatus = (order) => {
    if (order && order.completed_at) return { label: 'COMPLETED', class: 'pill--review' };
    const normalized = order ? String(order.status || '').toLowerCase() : '';
    if (normalized === 'rejected') return { label: 'REJECTED', class: 'pill--inactive' };
    if (normalized === 'accepted') return { label: 'APPROVED', class: 'pill--upcoming' };
    return { label: 'PENDING', class: 'pill--pending' };
  };
%>
<div class="app">
  <%- include("partials/coachSidebar", {
    active: "bookings"
  }) %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">BOOKINGS</div>
      <div class="topbar__pill"><i class="fa-solid fa-calendar-check"></i></div>
    </header>

    <section class="card">
      <div class="card__head">
        <div class="card__title">All Sessions</div>
        <form class="card__tools" method="get" action="/bookingsManage">
          <div class="search">
            <label class="sort__label" for="order-search">SEARCH</label>
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="order-search" name="search" type="search" placeholder="Booked by or sport type" value="<%= safeSearchTerm %>">
          </div>
          <div class="sort">
            <span class="sort__label">STATUS:</span>
            <select class="sort__btn" id="statusFilter" name="status">
              <option value="all" <%= activeStatus === 'all' ? 'selected' : '' %>>All</option>
              <option value="approved" <%= activeStatus === 'approved' ? 'selected' : '' %>>Approved</option>
              <option value="pending" <%= activeStatus === 'pending' ? 'selected' : '' %>>Pending</option>
              <option value="rejected" <%= activeStatus === 'rejected' ? 'selected' : '' %>>Rejected</option>
              <option value="completed" <%= activeStatus === 'completed' ? 'selected' : '' %>>Completed</option>
            </select>
          </div>
        </form>
      </div>

      <%- include('partials/flashMessages', { messages }) %>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>Booked By</th>
              <th>Booked At</th>
              <th>Coach Name</th>
              <th>Date &amp; Time</th>
              <th>Phone Number</th>
              <th>Email</th>
              <th>Sport</th>
              <th>Location</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% const rows = Array.isArray(orders) ? orders : []; %>
            <% if (!rows.length) { %>
              <tr>
                <td colspan="10">No bookings found.</td>
              </tr>
            <% } else { %>
              <% rows.forEach(o => { %>
                <% const statusMeta = resolveStatus(o); %>
                <% const bookedAt = formatSgDateTime(o.created_at); %>
                <% const bookedBy = o.username || '-'; %>
                <% const bookedEmail = o.user_email || '-'; %>
                <% const bookedPhone = o.user_contact || '-'; %>
                <% const items = Array.isArray(o.items) && o.items.length ? o.items : [null]; %>
                <% items.forEach(it => { %>
                  <% const coachName = it && it.username ? it.username : '-'; %>
                  <% const sportName = it && (it.sport || it.listing_title) ? (it.sport || it.listing_title) : '-'; %>
                  <% const location = it && it.session_location ? it.session_location : (o.session_location || '-'); %>
                  <% const dateLabel = it ? formatSessionDate(it.session_date) : 'TBC'; %>
                  <% const timeLabel = it ? formatSessionTime(it.session_time) : ''; %>
                  <tr>
                    <td><%= bookedBy %></td>
                    <td><%= bookedAt %></td>
                    <td>
                      <div><%= coachName %></div>
                      <% if (sportName && it && it.sport) { %>
                        <div class="cell-sub"><%= it.sport %></div>
                      <% } %>
                    </td>
                    <td><%= timeLabel ? `${dateLabel} ${timeLabel}` : dateLabel %></td>
                    <td><%= bookedPhone %></td>
                    <td><%= bookedEmail %></td>
                    <td><%= sportName %></td>
                    <td><%= location %></td>
                    <td>
                      <span class="pill <%= statusMeta.class %>"><%= statusMeta.label %></span>
                    </td>
                    <td>
                      <% if (String(o.status || '').toLowerCase() === 'pending') { %>
                        <form style="display:inline-block; margin-right:6px;" action="/bookingsManage/<%= o.id %>/status" method="post">
                          <input type="hidden" name="status" value="accepted">
                          <input type="hidden" name="page" value="<%= (pagination && pagination.page) || 1 %>">
                          <input type="hidden" name="search" value="<%= safeSearchTerm %>">
                          <input type="hidden" name="filterStatus" value="<%= activeStatus %>">
                          <button class="btn btn--primary btn--sm" type="submit">Approve</button>
                        </form>
                        <form style="display:inline-block;" action="/bookingsManage/<%= o.id %>/status" method="post">
                          <input type="hidden" name="status" value="rejected">
                          <input type="hidden" name="page" value="<%= (pagination && pagination.page) || 1 %>">
                          <input type="hidden" name="search" value="<%= safeSearchTerm %>">
                          <input type="hidden" name="filterStatus" value="<%= activeStatus %>">
                          <button class="btn btn--ghost btn--sm" type="submit">Reject</button>
                        </form>
                      <% } else { %>
                        <span class="cell-sub">Locked</span>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>

      <div class="card__foot">
        <% const pager = pagination || { page: 1, perPage: 10, totalOrders: 0, totalPages: 1 }; %>
        <% const startIndex = pager.totalOrders ? ((pager.page - 1) * pager.perPage + 1) : 0; %>
        <% const endIndex = Math.min(pager.page * pager.perPage, pager.totalOrders || 0); %>
        <div class="hint">Showing <%= startIndex %> to <%= endIndex %> of <%= pager.totalOrders %> bookings</div>

        <div class="pager">
          <% const buildQuery = (pageNum) => { %>
            <% const params = []; %>
            <% if (safeSearchTerm) params.push(`search=${encodeURIComponent(safeSearchTerm)}`); %>
            <% if (activeStatus) params.push(`status=${encodeURIComponent(activeStatus)}`); %>
            <% params.push(`page=${pageNum}`); %>
            <% return params.join('&'); %>
          <% }; %>
          <% if (pager.totalPages > 1) { %>
            <% if (pager.page > 1) { %>
              <a class="pager__btn" href="/bookingsManage?<%= buildQuery(pager.page - 1) %>"><i class="fa-solid fa-chevron-left"></i></a>
            <% } %>
            <% for (let p = 1; p <= pager.totalPages; p += 1) { %>
              <a class="pager__num <%= p === pager.page ? 'pager__num--active' : '' %>" href="/bookingsManage?<%= buildQuery(p) %>"><%= p %></a>
            <% } %>
            <% if (pager.page < pager.totalPages) { %>
              <a class="pager__btn" href="/bookingsManage?<%= buildQuery(pager.page + 1) %>"><i class="fa-solid fa-chevron-right"></i></a>
            <% } %>
          <% } else { %>
            <span class="pager__num pager__num--active">1</span>
          <% } %>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  const statusFilter = document.getElementById('statusFilter');
  statusFilter?.addEventListener('change', () => {
    statusFilter.form?.submit();
  });
</script>

<%- include('partials/footer') %>
