<%- include('partials/head', {
  title: 'Bookings',
  bodyClass: 'admin-page coach-dashboard',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/css/user-common.css">
    <link rel="stylesheet" href="/css/admin-common.css">
    <link rel="stylesheet" href="/css/user-dashboard.css">
    <link rel="stylesheet" href="/css/coach-dashboard.css">
  `
}) %>

<%
  const safeSearchTerm = typeof searchTerm !== 'undefined' ? searchTerm : '';
  const formatSgDateTime = (value) => {
    if (!value) return 'TBC';
    return new Date(value).toLocaleString('en-SG', { timeZone: 'Asia/Singapore' });
  };
  const formatSessionDate = (value) => {
    if (!value) return 'TBC';
    const iso = String(value).split('T')[0];
    const date = new Date(`${iso}T00:00:00+08:00`);
    return date.toLocaleDateString('en-SG');
  };
  const formatSessionTime = (value) => (value ? String(value).slice(0, 5) : 'TBC');
  const resolveStatus = (order) => {
    if (order && order.completed_at) return { label: 'COMPLETED', class: 'pill--review' };
    if (order && String(order.status || '').toLowerCase() === 'rejected') return { label: 'REJECTED', class: 'pill--inactive' };
    return { label: 'UPCOMING', class: 'pill--upcoming' };
  };
%>
<div class="app">
  <%- include("partials/coachSidebar", {
    active: "bookings"
  }) %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">BOOKINGS</div>
      <div class="topbar__pill"><i class="fa-solid fa-calendar-check"></i></div>
    </header>

    <section class="card">
      <div class="card__head">
        <div class="card__title">All Sessions</div>
        <form class="card__tools" method="get" action="/bookingsManage">
          <div class="search">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="order-search" name="search" type="search" placeholder="Search" value="<%= safeSearchTerm %>">
          </div>
          <div class="sort">
            <span class="sort__label">SORT BY:</span>
            <select class="sort__btn" name="sort">
              <option value="recent">Recent</option>
            </select>
          </div>
        </form>
      </div>

      <%- include('partials/flashMessages', { messages }) %>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>Booked By</th>
              <th>Booked At</th>
              <th>Coach Name</th>
              <th>Date &amp; Time</th>
              <th>Phone Number</th>
              <th>Email</th>
              <th>Sport</th>
              <th>Location</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% const rows = Array.isArray(orders) ? orders : []; %>
            <% if (!rows.length) { %>
              <tr>
                <td colspan="10">No bookings found.</td>
              </tr>
            <% } else { %>
              <% rows.forEach(o => { %>
                <% const statusMeta = resolveStatus(o); %>
                <% const bookedAt = formatSgDateTime(o.created_at); %>
                <% const bookedBy = o.username || '-'; %>
                <% const bookedEmail = o.user_email || '-'; %>
                <% const bookedPhone = o.user_contact || '-'; %>
                <% const items = Array.isArray(o.items) && o.items.length ? o.items : [null]; %>
                <% items.forEach(it => { %>
                  <% const coachName = it && it.username ? it.username : '-'; %>
                  <% const sportName = it && (it.sport || it.listing_title) ? (it.sport || it.listing_title) : '-'; %>
                  <% const location = it && it.session_location ? it.session_location : (o.session_location || '-'); %>
                  <% const dateLabel = it ? formatSessionDate(it.session_date) : 'TBC'; %>
                  <% const timeLabel = it ? formatSessionTime(it.session_time) : ''; %>
                  <tr>
                    <td><%= bookedBy %></td>
                    <td><%= bookedAt %></td>
                    <td>
                      <div><%= coachName %></div>
                      <% if (sportName && it && it.sport) { %>
                        <div class="cell-sub"><%= it.sport %></div>
                      <% } %>
                    </td>
                    <td><%= timeLabel ? `${dateLabel} ${timeLabel}` : dateLabel %></td>
                    <td><%= bookedPhone %></td>
                    <td><%= bookedEmail %></td>
                    <td><%= sportName %></td>
                    <td><%= location %></td>
                    <td>
                      <span class="pill <%= statusMeta.class %>"><%= statusMeta.label %></span>
                    </td>
                    <td>
                      <% if (String(o.status || '').toLowerCase() === 'pending') { %>
                        <form style="display:inline-block; margin-right:6px;" action="/bookingsManage/<%= o.id %>/status" method="post">
                          <input type="hidden" name="status" value="accepted">
                          <button class="btn btn--primary btn--sm" type="submit">Approve</button>
                        </form>
                        <form style="display:inline-block;" action="/bookingsManage/<%= o.id %>/status" method="post">
                          <input type="hidden" name="status" value="rejected">
                          <button class="btn btn--ghost btn--sm" type="submit">Reject</button>
                        </form>
                      <% } else { %>
                        <span class="cell-sub">Locked</span>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<%- include('partials/footer') %>