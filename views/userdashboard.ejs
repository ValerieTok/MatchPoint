<%- include('partials/head', {
  title: 'User Dashboard',
  bodyClass: 'admin-page admin-dashboard user-dashboard',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  `
}) %>

<div class="app">
  <%- include("partials/userSidebar", {
    active: "dashboard",
    courseCount: undefined
  }) %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">USER DASHBOARD PAGE</div>
    </header>

    <section class="hero">
      <div class="hero__left">
        <h1>Hello <span class="hero__name"><%= user?.username || (user?.email ? user.email.split('@')[0] : '') %></span> <span class="wave">ðŸ‘‹</span>,</h1>

        <div class="stats">
          <div class="stat">
            <div class="stat__icon"><i class="fa-solid fa-user-group"></i></div>
            <div class="stat__meta">
              <div class="stat__label">Upcoming Sessions</div>
              <div class="stat__value"><%= upcomingCount ?? 0 %></div>
            </div>
          </div>

          <div class="stat">
            <div class="stat__icon"><i class="fa-solid fa-award"></i></div>
            <div class="stat__meta">
              <div class="stat__label">Completed Sessions</div>
              <div class="stat__value"><%= completedCount ?? 0 %></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card__head">
        <div class="card__title">All Sessions</div>

        <form class="card__tools" method="get" action="/userdashboard">
          <div class="search search--wide">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="searchInput" name="search" type="search" placeholder="Search by coach name or sport" value="<%= filters?.search || '' %>" />
          </div>

          <div class="sort">
            <span class="sort__label">SORT BY:</span>
            <select class="sort__btn" name="sort">
              <option value="" <%= !filters?.sort ? 'selected' : '' %>>All</option>
              <option value="upcoming" <%= filters?.sort === 'upcoming' ? 'selected' : '' %>>Upcoming</option>
              <option value="completed" <%= filters?.sort === 'completed' ? 'selected' : '' %>>Completed</option>
            </select>
          </div>
        </form>
      </div>

      <div class="tableWrap">
        <table class="table" id="sessionsTable">
          <thead>
            <tr>
              <th>Coach Name</th>
              <th>Date &amp; Time</th>
              <th>Phone Number</th>
              <th>Email</th>
              <th>Sport</th>
              <th>Location</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            <%
              const rows = Array.isArray(sessions) ? sessions : [];
            %>

            <% if (!rows.length) { %>
              <tr>
                <td colspan="8">No sessions yet.</td>
              </tr>
            <% } else { %>
              <% rows.forEach(r => { %>
                <tr>
                  <td>
                    <div><%= r.coach || '-' %></div>
                    <% if (r.sport) { %>
                      <div class="cell-sub"><%= r.sport %></div>
                    <% } %>
                  </td>
                  <td>
                    <% const dateLabel = sessionDateHelper.formatSessionDate(r.date); %>
                    <% const timeLabel = sessionDateHelper.formatSessionTime(r.time); %>
                    <%= timeLabel ? `${dateLabel} ${timeLabel}` : dateLabel %>
                  </td>
                  <td><%= r.phone || '-' %></td>
                  <td><%= r.email || '-' %></td>
                  <td><%= r.sport || '-' %></td>
                  <td><%= r.location || '-' %></td>
                  <td>
                    <% const bookingStatus = String(r.bookingStatus || '').toLowerCase(); %>
                    <% if (r.completedAt) { %>
                      <span class="pill pill--review">CONFIRMED</span>
                      <% if ((r.refundStatus || '').toLowerCase() === 'approved') { %>
                        <span class="pill pill--refunded">REFUNDED</span>
                      <% } %>
                    <% } else if (bookingStatus === 'accepted') { %>
                      <span class="pill pill--upcoming">CONFIRMED</span>
                    <% } else if (bookingStatus === 'rejected') { %>
                      <span class="pill pill--inactive">UNCONFIRMED</span>
                    <% } else { %>
                      <span class="pill pill--pending">UNCONFIRMED</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (!r.completedAt) { %>
                      <form action="/bookingsUser/<%= r.bookingId %>/confirm-delivery" method="post">
                        <button class="btn btn--primary btn--sm" type="submit">Mark Complete</button>
                      </form>
                    <% } else { %>
                      <span class="cell-sub">-</span>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>

      <div class="card__foot">
        <% const pager = pagination || { page: 1, perPage: 10, totalSessions: 0, totalPages: 1 }; %>
        <% const startIndex = pager.totalSessions ? ((pager.page - 1) * pager.perPage + 1) : 0; %>
        <% const endIndex = Math.min(pager.page * pager.perPage, pager.totalSessions || 0); %>
        <div class="hint">Showing <%= startIndex %> to <%= endIndex %> of <%= pager.totalSessions %> entries</div>

        <div class="pager">
          <% const buildQuery = (pageNum) => { %>
            <% const params = []; %>
            <% if (filters && filters.search) params.push(`search=${encodeURIComponent(filters.search)}`); %>
            <% if (filters && filters.sort) params.push(`sort=${encodeURIComponent(filters.sort)}`); %>
            <% params.push(`page=${pageNum}`); %>
            <% return params.join('&'); %>
          <% }; %>
          <% if (pager.totalPages > 1) { %>
            <% if (pager.page > 1) { %>
              <a class="pager__btn" href="/userdashboard?<%= buildQuery(pager.page - 1) %>"><i class="fa-solid fa-chevron-left"></i></a>
            <% } %>
            <% for (let p = 1; p <= pager.totalPages; p += 1) { %>
              <a class="pager__num <%= p === pager.page ? 'pager__num--active' : '' %>" href="/userdashboard?<%= buildQuery(p) %>"><%= p %></a>
            <% } %>
            <% if (pager.page < pager.totalPages) { %>
              <a class="pager__btn" href="/userdashboard?<%= buildQuery(pager.page + 1) %>"><i class="fa-solid fa-chevron-right"></i></a>
            <% } %>
          <% } else { %>
            <span class="pager__num pager__num--active">1</span>
          <% } %>
        </div>
      </div>
    </section>
  </main>
</div>

<%- include('partials/footer', {
  extraScripts: `
    <script>
      const searchInput = document.getElementById("searchInput");
      const sortSelect = document.querySelector("select[name='sort']");
      sortSelect?.addEventListener("change", () => {
        sortSelect.form?.submit();
      });
      searchInput?.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          searchInput.form?.submit();
        }
      });
      searchInput?.addEventListener("input", () => {
        if (!searchInput.value.trim()) {
          searchInput.form?.submit();
        }
      });
    </script>
  `
}) %>
