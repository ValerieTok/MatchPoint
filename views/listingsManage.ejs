<%- include('partials/head', {
  title: 'Coach Dashboard',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" href="/css/user-common.css">
    <link rel="stylesheet" href="/css/coach-dashboard.css">
  `
}) %>

<% const totalListings = products ? products.length : 0; %>
<% const activeListings = (products || []).filter(p => typeof p.is_active === 'undefined' || p.is_active).length; %>
<% const hiddenListings = totalListings - activeListings; %>

<div class="app">
  <%- include("partials/coachSidebar", {
    active: "listings",
    listingCount: totalListings
  }) %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">COACH DASHBOARD</div>
      <div class="topbar__pill"><i class="fa-solid fa-dumbbell"></i></div>
    </header>

    <section class="hero">
      <div>
        <h1 class="hero__title">Hi, <%= user.username %>!</h1>
        <p class="hero__subtitle">
          <%= user.role === 'coach' ? 'Manage your coaching listings and sessions.' : 'Manage listings across the platform.' %>
        </p>
      </div>
    </section>

    <section class="stats">
      <div class="stat">
        <div class="stat__icon"><i class="fa-solid fa-layer-group"></i></div>
        <div>
          <div class="stat__label">Total Listings</div>
          <div class="stat__value"><%= totalListings %></div>
        </div>
      </div>
      <div class="stat stat--active">
        <div class="stat__icon"><i class="fa-solid fa-circle-check"></i></div>
        <div>
          <div class="stat__label">Active Listings</div>
          <div class="stat__value"><%= activeListings %></div>
        </div>
      </div>
      <div class="stat stat--hidden">
        <div class="stat__icon"><i class="fa-solid fa-eye-slash"></i></div>
        <div>
          <div class="stat__label">Hidden Listings</div>
          <div class="stat__value"><%= hiddenListings %></div>
        </div>
      </div>
    </section>

    <%- include('partials/flashMessages', { messages }) %>

    <section class="section">
      <div class="section__head">
        <div class="section__title">Your Listings</div>
      </div>
      <div class="section__foot section__foot--top">
        <a class="btn btn--ghost btn--sm" href="/addListing"><i class="fa-solid fa-circle-plus"></i> Add listing</a>
      </div>

      <% if (!products || !products.length) { %>
        <div class="empty">No listings found. Add your first listing to get started.</div>
      <% } else { %>
        <div class="listing-grid">
          <% products.forEach(p => { 
            const durationLabel = p.duration_minutes ? p.duration_minutes + ' mins' : null;
            const levelLabel = p.skill_level ? p.skill_level.toUpperCase() : null;
            const imageSrc = p.image || 'placeholder.png';
            const isActive = typeof p.is_active !== 'undefined' ? p.is_active : true;
            const priceLabel = typeof p.price !== 'undefined' && p.price !== null
              ? '$' + Number(p.price).toFixed(2)
              : null;
          %>
            <div class="listing-card">
              <div class="listing-card__media">
                <img src="/images/<%= imageSrc %>" alt="<%= p.listing_title %>">
              </div>
              <div class="listing-card__body">
                <div class="listing-card__title"><%= p.listing_title %></div>
                <div class="listing-card__meta">Coach: <%= p.username %></div>
                <% if (priceLabel) { %>
                  <div class="listing-card__price"><%= priceLabel %> per session</div>
                <% } %>
                <% if (p.description) { %>
                  <div class="listing-card__desc"><%= p.description %></div>
                <% } %>
                <div class="listing-card__tags">
                  <% if (levelLabel) { %>
                    <span class="tag"><%= levelLabel %></span>
                  <% } %>
                  <% if (durationLabel) { %>
                    <span class="tag tag--neutral"><%= durationLabel %></span>
                  <% } %>
                  <% if (p.session_location) { %>
                    <span class="tag tag--neutral"><%= p.session_location %></span>
                  <% } %>
                  <span class="tag <%= isActive ? 'tag--active' : 'tag--inactive' %>">
                    <%= isActive ? 'Active' : 'Hidden' %>
                  </span>
                </div>
                <div class="listing-card__actions">
                  <a class="action action--primary" href="/updateListing/<%= p.id %>">Edit</a>
                  <form method="post" action="/listingsManage/delete/<%= p.id %>" onsubmit="return confirm('Delete this listing?')">
                    <button class="action action--danger" type="submit">Delete</button>
                  </form>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </section>
  </main>
</div>

<%- include('partials/footer') %>

