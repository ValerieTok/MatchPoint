<%
  const netsAmount = (cart && cart.length)
    ? Number(cart[0].price || 0).toFixed(2)
    : '0.00';
  const netsSelected = Boolean(qrCodeUrl || txnRetrievalRef);
  const paypalAvailable = Boolean(paypalClientId);
  const stripeAvailable = Boolean(stripePublishableKey);
  const paypalScript = paypalAvailable
    ? `<script id="paypal-sdk" src="https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=${paypalCurrency}"></script>`
    : '';
%>

<%- include('partials/head', {
  title: 'Payment',
  bodyClass: 'admin-page payment-page',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    ${paypalScript}
  `
}) %>

<div class="app">
  <%- include("partials/userSidebar", { active: "cart" }) %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">PAYMENT</div>
      <div class="topbar__pill"><i class="fa-solid fa-wallet"></i></div>
    </header>

    <div class="payment-container">

      <div class="payment-layout">
        <div class="payment-main">
          <div class="payment-panel">
            <div class="payment-card">
              <h4 class="mb-1">Hello <%= user.full_name || user.username %></h4>
              <p class="text-muted mb-4">Complete your payment to confirm your booking</p>

              <%- include('partials/flashMessages', { messages }) %>

              <form id="paymentForm" action="/payment/confirm" method="POST">
                <div class="payment-form-grid">
                  <div class="payment-form-left">
                    <div class="payment-wallet mb-4">
                      <div class="payment-wallet__head">
                        <div>
                          <h6 class="fw-semibold mb-1">Use E-Wallet</h6>
                          <p class="text-muted small mb-0">Available: $<span id="walletBalanceDisplay"><%= Number(walletBalance || 0).toFixed(2) %></span></p>
                        </div>
                        <span class="wallet-badge">$<%= Number(walletBalance || 0).toFixed(2) %></span>
                      </div>
                      <div class="wallet-input">
                        <span class="wallet-input__prefix">$</span>
                        <input
                          id="walletDeductionInput"
                          name="walletDeduction"
                          class="form-control"
                          type="text"
                          inputmode="decimal"
                          value="<%= Number(walletDeduction || 0).toFixed(2) %>"
                          aria-label="Wallet amount to apply"
                        >
                      </div>
                      <button type="submit" class="btn btn-payment mt-3" id="confirmPaymentBtn" disabled>
                        Confirm Payment
                      </button>
                      <p class="text-muted small mb-0">Apply part of your E-Wallet balance and pay the rest using PayPal or NETS.</p>
                    </div>

                    <div class="mb-4">
                      <h6 class="fw-semibold mb-3">Payment Methods</h6>

                      <div class="d-flex flex-column gap-2">
                        <button type="button" class="payment-method" id="selectNets" aria-label="NETS QR">
                          <div class="card-logos">
                            <img src="/images/NETS.webp" alt="NETS" class="card-logo nets-logo">
                          </div>
                        </button>
                        <button type="button" class="payment-method" id="selectStripe" aria-label="Stripe">
                          <div class="card-logos">
                            <span class="stripe-word">stripe</span>
                          </div>
                        </button>
                        <input type="hidden" name="paymentMethod" id="paymentMethodInput" value="<%= paypalAvailable ? 'paypal' : '' %>">
                      </div>
                    </div>

                <div class="payment-form-details" id="paypalDetails">
                  <div class="mb-3">
                    <div id="paypal-button-container"></div>
                    <p class="text-muted small mt-2 mb-0">You will be charged $<span id="paypalAmountDisplay"><%= paypalAmount %></span> via PayPal.</p>
                    <p id="paypal-config-warning" class="text-muted small mt-2" style="display: none;">
                      PayPal is not configured. Add your PayPal client ID in the environment to enable checkout.
                    </p>
                  </div>
                </div>
                <div class="payment-form-details" id="stripeDetails" style="display: none;">
                  <p id="stripe-config-warning" class="text-muted small mt-2" style="display: none;">
                    Stripe is not configured. Add your Stripe keys in the environment to enable checkout.
                  </p>
                </div>

                  <div class="payment-form-details" id="netsqrDetails" style="display: none;">
                    <div class="mb-4">
                      <h6 class="fw-semibold mb-3">Scan QR Code to Pay</h6>

                      <% if (qrCodeUrl) { %>
                        <div class="d-flex justify-content-center">
                          <img src="<%= qrCodeUrl %>" alt="NETS QR Code" style="max-width: 260px; width: 100%;">
                        </div>
                        <p class="text-muted mt-2 small text-center">Scan this code with your mobile banking app to complete the payment</p>
                        <p class="text-muted small text-center mb-0" id="netsQrTimer">Time remaining: 05:00</p>
                      <% } else { %>
                        <p class="text-muted mt-3 small text-center">Generating NETS QR code...</p>
                      <% } %>

                    </div>
                  </div>


                  <div class="mb-3">
                    <label class="form-label fw-semibold">Email Address</label>
                    <input type="email" class="form-control" name="email" value="<%= user.email || '' %>" placeholder="yuwaranesri16@gmail.com">
                  </div>

                  <div class="mb-4">
                    <label class="form-label fw-semibold">Phone Number</label>
                    <input type="tel" class="form-control" name="phone" value="<%= user.contact || '' %>" placeholder="+65 8770 7650">
                  </div>

                  <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="termsCheck" required>
                    <label class="form-check-label small" for="termsCheck">
                      I agree to the terms and conditions and privacy policy. I understand that my payment will be processed securely
                    </label>
                  </div>
                </div>
              </div>

                <input type="hidden" name="orderId" value="<%= orderId %>">
              </form>
            </div>
          </div>
        </div>

        <div class="payment-summary">
          <div class="summary-card">
            <h5 class="fw-bold mb-4">Booking Summary</h5>

            <% if (cart && cart.length > 0) { 
              cart.forEach(item => { 
                const sessionDateLabel = sessionDateHelper.formatSessionDateLong(item.session_date);
                const sessionTime = sessionDateHelper.formatSessionTime(item.session_time);
                const quantity = Number(item.quantity || 1);
                const lineTotal = Number(item.price || 0) * quantity;
            %>
              <div class="mb-3">
                <h6 class="fw-semibold mb-2"><%= item.listing_title %></h6>
                <p class="text-muted small mb-2">with <%= item.username %></p>

                <div class="summary-item small">
                  <div class="icon-circle"><i class="fa-regular fa-calendar"></i></div>
                  <span class="text-muted"><%= sessionDateLabel %></span>
                </div>

                <div class="summary-item small">
                  <div class="icon-circle"><i class="fa-regular fa-clock"></i></div>
                  <span class="text-muted"><%= sessionTime %></span>
                </div>

                <div class="summary-item small">
                  <div class="icon-circle"><i class="fa-solid fa-location-dot"></i></div>
                  <span class="text-muted"><%= item.session_location || 'TBC' %></span>
                </div>
                <div class="summary-item small">
                  <div class="icon-circle"><i class="fa-solid fa-layer-group"></i></div>
                  <span class="text-muted">Slots: <%= quantity %></span>
                </div>
              </div>

              <hr>

              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Session fee</span>
                <span class="fw-semibold">$<%= lineTotal.toFixed(2) %></span>
              </div>
              <% }) %>

              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Service fee</span>
                <span class="fw-semibold">$<%= Number(serviceFee || 0).toFixed(2) %></span>
              </div>

              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">E-Wallet applied</span>
                <span class="fw-semibold text-danger">-$<span id="walletAppliedDisplay"><%= Number(walletDeduction || 0).toFixed(2) %></span></span>
              </div>

              <div class="summary-total d-flex justify-content-between">
                <span>Amount due</span>
                <span class="text-success">$<span id="amountDueDisplay"><%= Number(amountDue || 0).toFixed(2) %></span></span>
              </div>
            <% } else { %>
              <p class="text-muted">No items in booking</p>
            <% } %>

          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<form id="netsQrForm" action="/generateNETSQR" method="POST">
  <input type="hidden" name="cartTotal" value="<%= Number(total || 0).toFixed(2) %>">
  <input type="hidden" name="orderId" value="<%= orderId %>">
  <input type="hidden" name="walletDeduction" id="walletDeductionFieldNets" value="<%= Number(walletDeduction || 0).toFixed(2) %>">
</form>

<!-- NETS payment -->
 <script src="https://unpkg.com/event-source-polyfill"></script>
<script>
  const txnRetrievalRef = "<%= txnRetrievalRef || '' %>";
  const fullNetsResponse = <%- JSON.stringify(fullNetsResponse || {}) %>;
  const paypalAvailable = <%- JSON.stringify(paypalAvailable) %>;
  const stripeAvailable = <%- JSON.stringify(stripeAvailable) %>;
  const netsSelected = <%- JSON.stringify(netsSelected) %>;
  const cartHasItems = <%- JSON.stringify(Boolean(cart && cart.length)) %>;
  const qrCodeUrl = "<%= qrCodeUrl || '' %>";

  const selectNetsBtn = document.getElementById("selectNets");
  const selectStripeBtn = document.getElementById("selectStripe");
  const paymentMethodInput = document.getElementById("paymentMethodInput");
  const paymentForm = document.getElementById("paymentForm");
  const paypalDetails = document.getElementById("paypalDetails");
  const stripeDetails = document.getElementById("stripeDetails");
  const netsqrDetails = document.getElementById("netsqrDetails");
  const confirmPaymentBtn = document.getElementById("confirmPaymentBtn");
  const paypalWarning = document.getElementById("paypal-config-warning");
  const stripeWarning = document.getElementById("stripe-config-warning");
  const walletDeductionInput = document.getElementById("walletDeductionInput");
  const walletDeductionFieldNets = document.getElementById("walletDeductionFieldNets");
  const walletAppliedDisplay = document.getElementById("walletAppliedDisplay");
  const amountDueDisplay = document.getElementById("amountDueDisplay");
  const paypalAmountDisplay = document.getElementById("paypalAmountDisplay");
  const termsCheck = document.getElementById("termsCheck");
  const netsQrTimer = document.getElementById("netsQrTimer");
  const termsKey = 'paymentTermsAccepted';
  const termsPersistKey = 'paymentTermsPersist';
  let paypalButtonsRendered = false;
  let paypalRenderQueued = false;
  let paypalScriptLoading = false;

  const baseTotal = Number(<%= (Number(total || 0) + Number(serviceFee || 0)).toFixed(2) %>);
  const walletBalance = Number(<%= Number(walletBalance || 0).toFixed(2) %>);
  let walletInputLocked = false;

  const clampMoney = (value, min, max) => {
    const num = Number(value);
    if (!Number.isFinite(num)) return min;
    return Math.min(Math.max(num, min), max);
  };

  const formatCurrencyInput = (raw) => {
    const digits = String(raw || '').replace(/\D/g, '');
    const safeDigits = digits.replace(/^0+(?=\d)/, '');
    const padded = safeDigits.padStart(3, '0');
    const cents = padded.slice(-2);
    const dollars = padded.slice(0, -2) || '0';
    return `${Number(dollars)}.${cents}`;
  };

  const updateWalletDeduction = (value, source) => {
    const maxDeduction = Math.min(walletBalance, baseTotal);
    const next = Number(clampMoney(value, 0, maxDeduction).toFixed(2));
    if (walletDeductionInput) {
      walletDeductionInput.value = next.toFixed(2);
    }
    if (walletDeductionFieldNets) {
      walletDeductionFieldNets.value = next.toFixed(2);
    }
    const due = Math.max(0, Number((baseTotal - next).toFixed(2)));

    if (walletAppliedDisplay) walletAppliedDisplay.textContent = next.toFixed(2);
    if (amountDueDisplay) amountDueDisplay.textContent = due.toFixed(2);
    if (paypalAmountDisplay) paypalAmountDisplay.textContent = due.toFixed(2);

    if (due <= 0 && paymentMethodInput) {
      paymentMethodInput.value = "wallet";
    } else if (paymentMethodInput && paymentMethodInput.value === "wallet") {
      paymentMethodInput.value = paypalAvailable ? "paypal" : (stripeAvailable ? "stripe" : "");
    }
    if (confirmPaymentBtn) {
      const canConfirm = due <= 0 && cartHasItems && (!termsCheck || termsCheck.checked);
      confirmPaymentBtn.disabled = !canConfirm;
    }
    if (selectNetsBtn) {
      const blocked = due <= 0 || (termsCheck && !termsCheck.checked);
      selectNetsBtn.disabled = blocked;
      selectNetsBtn.classList.toggle("is-disabled", blocked);
    }
    if (selectStripeBtn) {
      const blocked = due <= 0 || (termsCheck && !termsCheck.checked);
      selectStripeBtn.disabled = blocked;
      selectStripeBtn.classList.toggle("is-disabled", blocked);
    }
  };

  const ensurePaypalSdk = () => {
    if (window.paypal || !paypalAvailable) {
      return;
    }
    const existing = document.getElementById('paypal-sdk');
    if (existing || paypalScriptLoading) {
      return;
    }
    paypalScriptLoading = true;
    const script = document.createElement('script');
    script.id = 'paypal-sdk';
    script.src = `https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=<%= paypalCurrency %>`;
    script.onload = () => {
      paypalScriptLoading = false;
      renderPaypalButtons();
    };
    script.onerror = () => {
      paypalScriptLoading = false;
      if (paypalWarning) {
        paypalWarning.style.display = "block";
      }
    };
    document.head.appendChild(script);
  };

  const renderPaypalButtons = () => {
    const paypalContainer = document.getElementById('paypal-button-container');
    if (paypalContainer && paypalContainer.childElementCount === 0) {
      paypalButtonsRendered = false;
    }
    if (paypalButtonsRendered || !paypalAvailable) {
      if (!paypalAvailable && paypalWarning) {
        paypalWarning.style.display = "block";
      }
      return;
    }
    if (!window.paypal) {
      ensurePaypalSdk();
      if (!paypalRenderQueued) {
        paypalRenderQueued = true;
        const warnTimeout = setTimeout(() => {
          if (!window.paypal && paypalWarning) {
            paypalWarning.style.display = "block";
          }
        }, 3500);
        const waitForPaypal = () => {
          if (window.paypal) {
            clearTimeout(warnTimeout);
            paypalRenderQueued = false;
            renderPaypalButtons();
            return;
          }
          setTimeout(waitForPaypal, 200);
        };
        waitForPaypal();
      }
      return;
    }
    if (!cartHasItems) {
      return;
    }

    if (!paypalContainer) {
      return;
    }
    paypalButtonsRendered = true;
    paypal.Buttons({
      createOrder: function () {
        const walletDeduction = walletDeductionInput ? Number(walletDeductionInput.value || 0) : 0;
        return fetch('/api/paypal/create-order', {
          method: 'post',
          headers: {
            'content-type': 'application/json'
          },
          body: JSON.stringify({ walletDeduction })
        })
          .then(res => res.json())
          .then(data => {
            if (data && data.error) {
              alert(data.error);
              throw new Error(data.error);
            }
            return data.id;
          });
      },
      onApprove: function (data) {
        return fetch('/api/paypal/capture-order', {
          method: 'post',
          headers: {
            'content-type': 'application/json'
          },
          body: JSON.stringify({ orderID: data.orderID })
        })
          .then(res => res.json())
          .then(result => {
            if (result.success && result.redirectUrl) {
              window.location.href = result.redirectUrl;
              return;
            }
            alert('Payment not completed.');
          });
      },
      onClick: function (data, actions) {
        sessionStorage.setItem(termsPersistKey, 'true');
        if (!cartHasItems) {
          alert('Your booking cart is empty. Please add items before paying.');
          return actions.reject();
        }
        if (termsCheck && !termsCheck.checked) {
          alert('Please agree to the terms and conditions before paying.');
          return actions.reject();
        }
        return actions.resolve();
      }
    }).render('#paypal-button-container');
  };

  const setPaymentMethod = (value) => {
    if (paymentMethodInput) {
      paymentMethodInput.value = value || "";
    }
    if (selectNetsBtn) selectNetsBtn.classList.toggle('active', value === "netsqr");
    if (selectStripeBtn) selectStripeBtn.classList.toggle('active', value === "stripe");
    syncPaymentUi();
  };

  const syncPaymentUi = () => {
    const selected = paymentMethodInput ? paymentMethodInput.value : "";
    const isNets = selected === "netsqr";
    const isStripe = selected === "stripe";
    const walletDeduction = walletDeductionInput ? Number(walletDeductionInput.value || 0) : 0;
    const due = Math.max(0, Number((baseTotal - walletDeduction).toFixed(2)));
    if (paypalDetails) paypalDetails.style.display = paypalAvailable ? "block" : "none";
    if (stripeDetails) stripeDetails.style.display = isStripe ? "block" : "none";
    if (netsqrDetails) netsqrDetails.style.display = isNets ? "block" : "none";
    if (confirmPaymentBtn) {
      const canConfirm = due <= 0 && cartHasItems && (!termsCheck || termsCheck.checked);
      confirmPaymentBtn.disabled = !canConfirm;
    }

    if (paypalAvailable) {
      setTimeout(renderPaypalButtons, 0);
    } else if (paypalWarning) {
      paypalWarning.style.display = "block";
    }
    if (!stripeAvailable && stripeWarning && isStripe) {
      stripeWarning.style.display = "block";
    }
  };

  if (selectNetsBtn) {
    selectNetsBtn.addEventListener("click", () => {
      sessionStorage.setItem(termsPersistKey, 'true');
      if (termsCheck && !termsCheck.checked) {
        alert('Please agree to the terms and conditions before paying.');
        return;
      }
      setPaymentMethod("netsqr");
      if (!qrCodeUrl) {
        const form = document.getElementById("netsQrForm");
        if (form) {
          form.submit();
        }
      }
    });
  }
  if (selectStripeBtn) {
    selectStripeBtn.addEventListener("click", () => {
      sessionStorage.setItem(termsPersistKey, 'true');
      if (termsCheck && !termsCheck.checked) {
        alert('Please agree to the terms and conditions before paying.');
        return;
      }
      setPaymentMethod("stripe");
      if (!stripeAvailable) return;
      const walletDeduction = walletDeductionInput ? Number(walletDeductionInput.value || 0) : 0;
      fetch('/api/stripe/create-checkout-session', {
        method: 'post',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ walletDeduction })
      })
        .then(res => res.json())
        .then(data => {
          if (data.url) {
            window.location.href = data.url;
            return;
          }
          alert(data.error || 'Unable to start Stripe checkout.');
        });
    });
  }
  const initialMethod = netsSelected ? "netsqr" : (paypalAvailable ? "paypal" : (stripeAvailable ? "stripe" : ""));
  setPaymentMethod(initialMethod);
  if (paypalAvailable) {
    renderPaypalButtons();
  }

  if (walletDeductionInput) {
    updateWalletDeduction(walletDeductionInput.value);
    walletDeductionInput.addEventListener("input", (e) => {
      if (walletInputLocked) return;
      walletInputLocked = true;
      const formatted = formatCurrencyInput(e.target.value);
      e.target.value = formatted;
      walletInputLocked = false;
      updateWalletDeduction(formatted, "input");
      e.target.setSelectionRange(e.target.value.length, e.target.value.length);
    });
    walletDeductionInput.addEventListener("focus", (e) => {
      e.target.setSelectionRange(e.target.value.length, e.target.value.length);
    });
  }
  if (termsCheck) {
    const shouldPersist = sessionStorage.getItem(termsPersistKey) === 'true';
    if (!shouldPersist) {
      sessionStorage.removeItem(termsKey);
    }
    sessionStorage.setItem(termsPersistKey, 'false');
    const savedTerms = sessionStorage.getItem(termsKey);
    if (savedTerms === 'true') {
      termsCheck.checked = true;
    }
    updateWalletDeduction(walletDeductionInput ? walletDeductionInput.value : 0);
    termsCheck.addEventListener("change", () => updateWalletDeduction(walletDeductionInput ? walletDeductionInput.value : 0));
    termsCheck.addEventListener("change", () => {
      sessionStorage.setItem(termsKey, termsCheck.checked ? 'true' : 'false');
    });
  }

  const clearTermsPersist = () => {
    sessionStorage.removeItem(termsKey);
    sessionStorage.removeItem(termsPersistKey);
  };

  document.addEventListener('click', (event) => {
    const link = event.target.closest && event.target.closest('a[href]');
    if (!link) return;
    const href = link.getAttribute('href') || '';
    if (!href || href.startsWith('#')) return;
    if (/^https?:\/\//i.test(href)) return;
    if (href.startsWith('/payment')) return;
    clearTermsPersist();
  });
  if (paymentForm) {
    paymentForm.addEventListener("submit", (event) => {
      const walletDeduction = walletDeductionInput ? Number(walletDeductionInput.value || 0) : 0;
      const due = Math.max(0, Number((baseTotal - walletDeduction).toFixed(2)));
      if (due > 0) {
        event.preventDefault();
        alert('E-Wallet payments must cover the full amount. Please use PayPal or NETS for the remaining balance.');
        return;
      }
      if (paymentMethodInput) {
        paymentMethodInput.value = "wallet";
      }
    });
  }

  let netsCountdownInterval = null;
  let netsCountdownTimeout = null;
  const startNetsCountdown = (seconds, failUrl) => {
    if (!netsQrTimer || !Number.isFinite(seconds) || seconds <= 0) return;
    const deadline = Date.now() + seconds * 1000;
    const format = (remaining) => {
      const min = Math.floor(remaining / 60);
      const sec = remaining % 60;
      return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    };
    const tick = () => {
      const remaining = Math.max(0, Math.ceil((deadline - Date.now()) / 1000));
      netsQrTimer.textContent = `Time remaining: ${format(remaining)}`;
      if (remaining <= 0) {
        if (netsCountdownInterval) clearInterval(netsCountdownInterval);
        netsCountdownInterval = null;
      }
    };
    tick();
    netsCountdownInterval = setInterval(tick, 1000);
    netsCountdownTimeout = setTimeout(() => {
      if (netsCountdownInterval) clearInterval(netsCountdownInterval);
      netsCountdownInterval = null;
      window.location.href = failUrl;
    }, seconds * 1000);
  };

  if (txnRetrievalRef) {
    const url = `/sse/payment-status/${txnRetrievalRef}`;
    const s2sNetsTxnStatus = new EventSourcePolyfill(url, { heartbeatTimeout: 150000 });
    const netsFailUrl = `/nets-qr/fail?txn_retrieval_ref=${txnRetrievalRef}`;
    if (qrCodeUrl && netsQrTimer) {
      startNetsCountdown(300, netsFailUrl);
    }

    s2sNetsTxnStatus.addEventListener("message", (event) => {
      const data = JSON.parse(event.data);
      if (data.success) {
        s2sNetsTxnStatus.close();
        if (netsCountdownInterval) clearInterval(netsCountdownInterval);
        if (netsCountdownTimeout) clearTimeout(netsCountdownTimeout);
        window.location.href = `/nets-qr/success?txn_retrieval_ref=${txnRetrievalRef}`;
      } else if (data.fail) {
        s2sNetsTxnStatus.close();
        if (netsCountdownInterval) clearInterval(netsCountdownInterval);
        if (netsCountdownTimeout) clearTimeout(netsCountdownTimeout);
        window.location.href = netsFailUrl;
      }
    });

  }
</script>


<%- include('partials/footer') %>
