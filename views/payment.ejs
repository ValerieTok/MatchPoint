<%- include('partials/head', {
  title: 'Payment',
  bodyClass: 'admin-page payment-page',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  `
}) %>

<div class="app">
  <%- include("partials/userSidebar", { active: "cart" }) %>

  <main class="main">
    <header class="topbar">
      <div class="crumb">PAYMENT</div>
      <div class="topbar__pill"><i class="fa-solid fa-wallet"></i></div>
    </header>

    <div class="payment-container">
      <div class="payment-title">USER WALLET PAGE</div>

      <div class="row g-4 align-items-start">
        <div class="col-lg-8">
          <div class="payment-panel">
            <div class="payment-card">
              <h4 class="mb-1">Hello <%= user.full_name || user.username %> dY`<,</h4>
              <p class="text-muted mb-4">Complete your payment to confirm your booking</p>

              <%- include('partials/flashMessages', { messages }) %>

              <form id="paymentForm" action="/payment/confirm" method="POST">
              <div class="payment-form-grid">
                <div class="payment-form-left">
                  <div class="mb-4">
                    <h6 class="fw-semibold mb-3">Payment Method</h6>

                      <label class="payment-method active">
                        <input type="radio" name="paymentMethod" value="paypal" checked>
                        <span class="payment-icon"><i class="fa-brands fa-paypal"></i></span>
                        <span class="fw-semibold">PayPal</span>
                        <div class="card-logos">
                          <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" class="card-logo">
                        </div>
                      </label>
                    <label class="payment-method">
                      <input type="radio" name="paymentMethod" value="netsqr">
                      <span class="payment-icon"><i class="fa-solid fa-qrcode"></i></span>
                      <span class="fw-semibold">NETS QR</span>
                    </label>
                  </div>

                <div class="payment-form-details" id="cardDetails" style="display: none;">
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Cardholder Name</label>
                    <input type="text" class="form-control" name="cardholderName" placeholder="Yuwarane Sri">
                  </div>

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Card Number</label>
                      <input type="text" class="form-control" name="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>

                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Expiry Date</label>
                        <input type="text" class="form-control" name="expiryDate" placeholder="MM/YY" maxlength="5">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">CVV</label>
                        <input type="text" class="form-control" name="cvv" placeholder="123" maxlength="3">
                      </div>
                  </div>
                </div>

                <div class="payment-form-details" id="netsqrDetails" style="display: none;">
                  <div class="mb-4">
                    <h6 class="fw-semibold mb-3">Scan QR Code to Pay</h6>
                    <div class="d-flex justify-content-center">
                      <div class="netsqr-qrcode-container" id="netsqrQRCode"></div>
                    </div>
                    <p class="text-muted mt-3 small text-center">Scan this code with your mobile banking app to complete the payment</p>
                    <div class="mt-3 text-center">
                      <label class="form-check-label">
                        <input type="checkbox" class="form-check-input" name="netsqrConfirm" id="netsqrConfirm">
                        I have scanned and completed the payment
                      </label>
                    </div>
                  </div>
                </div>
              </div>

                <div class="mb-3">
                  <label class="form-label fw-semibold">Email Address</label>
                  <input type="email" class="form-control" name="email" value="<%= user.email || '' %>" placeholder="yuwaranesri16@gmail.com">
                </div>

                <div class="mb-4">
                  <label class="form-label fw-semibold">Phone Number</label>
                  <input type="tel" class="form-control" name="phone" value="<%= user.contact || '' %>" placeholder="+65 8770 7650">
                </div>

                <div class="form-check mb-4">
                  <input class="form-check-input" type="checkbox" id="termsCheck" required>
                  <label class="form-check-label small" for="termsCheck">
                    I agree to the terms and conditions and privacy policy. I understand that my payment will be processed securely
                  </label>
                </div>
              </div>

                <input type="hidden" name="orderId" value="<%= orderId %>">
              </form>
            </div>
          </div>
        </div>

        <div class="col-lg-4 payment-summary">
          <div class="summary-card">
            <h5 class="fw-bold mb-4">Booking Summary</h5>

            <% if (cart && cart.length > 0) { 
              cart.forEach(item => { 
                const sessionDate = item.session_date ? new Date(item.session_date).toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) : 'TBC';
                const sessionTime = item.session_time ? String(item.session_time).slice(0, 5) : 'TBC';
            %>
              <div class="mb-3">
                <h6 class="fw-semibold mb-2"><%= item.listing_title %></h6>
                <p class="text-muted small mb-2">with <%= item.username %></p>

                <div class="summary-item small">
                  <div class="icon-circle"><i class="fa-regular fa-calendar"></i></div>
                  <span class="text-muted"><%= sessionDate %></span>
                </div>

                <div class="summary-item small">
                  <div class="icon-circle"><i class="fa-regular fa-clock"></i></div>
                  <span class="text-muted"><%= sessionTime %></span>
                </div>

                <div class="summary-item small">
                  <div class="icon-circle"><i class="fa-solid fa-location-dot"></i></div>
                  <span class="text-muted"><%= item.session_location || 'TBC' %></span>
                </div>
              </div>

              <hr>

              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Session fee</span>
                <span class="fw-semibold">$<%= Number(item.price || 0).toFixed(2) %></span>
              </div>
              <% }) %>

              <div class="d-flex justify-content-between mb-3">
                <span class="text-muted">Service fee</span>
                <span class="fw-semibold">$2.50</span>
              </div>

              <div class="summary-total d-flex justify-content-between">
                <span>Total</span>
                <span class="text-success">$<%= (Number(total || 0) + 2.50).toFixed(2) %></span>
              </div>
            <% } else { %>
              <p class="text-muted">No items in booking</p>
            <% } %>

            <button type="submit" form="paymentForm" class="btn btn-danger btn-payment w-100 mt-4">
              Confirm Payment
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  // Generate NETS QR code
  function generateNetsQRCode() {
    const container = document.getElementById('netsqrQRCode');
    if (container) {
      container.innerHTML = '';
      // Generate a sample NETS QR code - in production, this should be a real transaction reference
      const qrData = `00020126360014SG.PAYNOW0107121234567890520400005303702540520025406112.005802SG6304D4F4`;
      try {
        new QRCode(container, {
          text: qrData,
          width: 250,
          height: 250,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
      } catch (err) {
        console.error('QR Code generation error:', err);
        container.innerHTML = '<p class="text-danger">Error generating QR code</p>';
      }
    }
  }

  document.querySelector('input[name="cardNumber"]')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    e.target.value = formattedValue;
  });

  document.querySelector('input[name="expiryDate"]')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
      value = value.slice(0, 2) + '/' + value.slice(2, 4);
    }
    e.target.value = value;
  });

  document.querySelector('input[name="cvv"]')?.addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '');
  });

  const methodInputs = document.querySelectorAll('input[name="paymentMethod"]');
  const methodLabels = document.querySelectorAll('.payment-method');
  const cardDetails = document.getElementById('cardDetails');
  const netsqrDetails = document.getElementById('netsqrDetails');
  
  methodInputs.forEach((input) => {
    input.addEventListener('change', () => {
      methodLabels.forEach((label) => label.classList.remove('active'));
      input.closest('.payment-method')?.classList.add('active');
      
      // Show/hide form details based on payment method
      const selectedMethod = input.value;
      if (selectedMethod === 'paypal') {
        cardDetails.style.display = 'block';
        netsqrDetails.style.display = 'none';
        // Set required on card fields
        cardDetails.querySelectorAll('input').forEach(field => {
          field.setAttribute('required', 'required');
        });
      } else if (selectedMethod === 'netsqr') {
        cardDetails.style.display = 'none';
        netsqrDetails.style.display = 'block';
        generateNetsQRCode();
        // Remove required from card fields
        cardDetails.querySelectorAll('input').forEach(field => {
          field.removeAttribute('required');
        });
      }
    });
  });

  // Handle form submission for NETS QR
  document.getElementById('paymentForm')?.addEventListener('submit', function(e) {
    const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    if (selectedMethod === 'netsqr') {
      const confirmed = document.getElementById('netsqrConfirm')?.checked;
      if (!confirmed) {
        e.preventDefault();
        alert('Please confirm that you have completed the payment by scanning the QR code');
      }
    }
  });

  // Initialize on page load
  window.addEventListener('load', () => {
    const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    if (selectedMethod === 'paypal' || selectedMethod === 'nets') {
      cardDetails.style.display = 'block';
      netsqrDetails.style.display = 'none';
      cardDetails.querySelectorAll('input').forEach(field => {
        field.setAttribute('required', 'required');
      });
    } else if (selectedMethod === 'netsqr') {
      cardDetails.style.display = 'none';
      netsqrDetails.style.display = 'block';
      // Give QRCode library time to load
      setTimeout(generateNetsQRCode, 100);
    }
  });
</script>

<%- include('partials/footer') %>
