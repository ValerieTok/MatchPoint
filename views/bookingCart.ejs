<%- include('partials/head', {
  title: 'MatchPoint - Booking Cart',
  bodyClass: 'admin-page user-cart',
  extraHead: `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  `
}) %>

<div class="app">

    <!-- SIDEBAR -->
    <%- include("partials/userSidebar", {
      active: "cart",
      courseCount: undefined
    }) %>

    <!-- MAIN -->
    <main class="main">
      <header class="topbar">
        <div class="crumb">BOOKING CART</div>
        <div class="topbar__pill"><i class="fa-solid fa-cart-shopping"></i></div>
      </header>

      <section class="hero">
        <div class="hero__left">
          <h1>Shopping <span class="hero__name">Cart</span> üõí</h1>
          <p style="color: #666; margin-top: 0.5rem;"><%= cart && cart.length ? cart.length : 0 %> item(s) in your cart</p>
        </div>
      </section>

      <%- include('partials/flashMessages', { messages }) %>

      <%- include('partials/flashMessages', { messages }) %>

      <% if (!cart || cart.length === 0) { %>
        <section class="card" style="text-align: center; padding: 3rem;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">üõí</div>
          <h3 style="margin-bottom: 0.5rem;">Your cart is empty</h3>
          <p style="color: #666; margin-bottom: 2rem;">Start adding coaching sessions to your cart</p>
          <a href="/viewcourses" style="display: inline-block; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 0.75rem 2rem; border-radius: 8px; text-decoration: none; font-weight: 600;">Browse Coaches</a>
        </section>
      <% } else { %>
        <% let total = 0; %>
        <% let totalSavings = 0; %>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem; max-width: 1400px;">
          <div>
            <% cart.forEach(item => { 
              const basePrice = Number(item.price || 0);
              const discountPercentage = Math.min(100, Math.max(0, Number(item.discount_percentage) || 0));
              const hasDiscount = discountPercentage > 0;
              const finalPrice = hasDiscount
                ? Number((basePrice * (1 - discountPercentage / 100)).toFixed(2))
                : basePrice;
              const sub = finalPrice * item.quantity;
              total += sub;
              if (hasDiscount) { totalSavings += (basePrice - finalPrice) * item.quantity; }
              const sessionDateLabel = item.session_date ? new Date(item.session_date).toLocaleDateString() : 'TBC';
              const sessionTimeLabel = item.session_time ? String(item.session_time).slice(0, 5) : 'TBC';
            %>
              <section class="card" style="margin-bottom: 1rem; padding: 2rem;">
                <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem;">
                  <div style="width: 140px; height: 140px; border-radius: 16px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0;">
                    <% if (item.image) { %>
                      <img src="/images/<%= item.image %>" alt="<%= item.listing_title %>" style="width: 100%; height: 100%; object-fit: cover;">
                    <% } else { %>
                      <span style="color: #999; font-size: 0.9rem;">No image</span>
                    <% } %>
                  </div>
                  
                  <div style="flex: 1;">
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: #1a1a1a;"><%= item.listing_title %></h3>
                    <p style="color: #6b7280; font-size: 1rem; margin: 0 0 1rem 0;">Coach: <%= item.username %><% if (item.sport) { %> ‚Ä¢ <%= item.sport %><% } %></p>
                    
                    <% if (hasDiscount) { %>
                      <div style="margin-bottom: 0.5rem;">
                        <span style="color: #9ca3af; text-decoration: line-through; font-size: 1rem; margin-right: 0.75rem;">$<%= basePrice.toFixed(2) %></span>
                        <span style="color: #22c55e; font-weight: 700; font-size: 1.25rem;">$<%= finalPrice.toFixed(2) %></span>
                        <span style="background: #22c55e; color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.8rem; margin-left: 0.75rem; font-weight: 600;"><%= discountPercentage.toFixed(0) %>% off</span>
                      </div>
                    <% } else { %>
                      <div style="font-weight: 700; margin-bottom: 1rem; font-size: 1.75rem; color: #1a1a1a;">$<%= basePrice.toFixed(2) %></div>
                    <% } %>
                  </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1.5rem; color: #6b7280; font-size: 0.95rem; margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 12px; flex-wrap: wrap;">
                  <% if (item.duration_minutes) { %>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="font-size: 1.25rem;">‚è±Ô∏è</span>
                      <span style="font-weight: 500;"><%= item.duration_minutes %> mins</span>
                    </div>
                  <% } %>
                  <% if (item.session_location) { %>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="fa-solid fa-location-dot"></i>
                      <span style="font-weight: 500;"><%= item.session_location %></span>
                    </div>
                  <% } %>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.25rem;">üìÖ</span>
                    <span style="font-weight: 500;"><%= sessionDateLabel %></span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.25rem;">üïê</span>
                    <span style="font-weight: 500;"><%= sessionTimeLabel %></span>
                  </div>
                </div>
                
                <% if (item.offer_message) { %>
                  <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6; padding: 0.75rem 1rem; font-size: 0.9rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <strong style="color: #1e40af;">Promo:</strong> <span style="color: #1e3a8a;"><%= item.offer_message %></span>
                  </div>
                <% } %>
                
                <div style="display: flex; gap: 1rem; align-items: center; justify-content: space-between;">
                  <form style="display: flex; align-items: center; gap: 0.75rem;" action="/bookingCart/update/<%= item.listing_id %>" method="POST">
                    <label style="font-size: 0.95rem; color: #6b7280; font-weight: 500;">Slots:</label>
                    <input
                      type="number"
                      style="width: 90px; padding: 0.6rem 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; font-weight: 500; text-align: center;"
                      name="quantity"
                      min="1"
                      value="<%= item.quantity %>"
                      required>
                    <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.2s;">Update</button>
                  </form>
                  
                  <form action="/bookingCart/remove/<%= item.listing_id %>" method="POST">
                    <button type="submit" style="background: #ef4444; color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;">
                      <span style="font-size: 1.1rem;">üóëÔ∏è</span> Remove
                    </button>
                  </form>
                </div>
                
                <div style="text-align: right; padding-top: 1.5rem; margin-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                  <p style="color: #6b7280; font-size: 0.9rem; margin: 0 0 0.5rem 0; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Subtotal</p>
                  <h2 style="margin: 0; font-size: 2rem; font-weight: 800; color: #1a1a1a;">$<%= sub.toFixed(2) %></h2>
                </div>
              </section>
            <% }) %>
          </div>
          
          <div>
            <section class="card" style="position: sticky; top: 2rem; padding: 1.5rem;">
              <h3 style="margin: 0 0 1.5rem 0;">Order Summary</h3>
              
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                <span style="color: #666;">Subtotal</span>
                <span style="font-weight: 600;">$<%= total.toFixed(2) %></span>
              </div>
              
              <% if (totalSavings > 0) { %>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; color: #22c55e;">
                  <span>Savings</span>
                  <span style="font-weight: 600;">-$<%= totalSavings.toFixed(2) %></span>
                </div>
              <% } %>
              
              <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 1rem 0;">
              
              <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                <span style="font-weight: 600;">Total</span>
                <span style="font-weight: 600; color: #22c55e; font-size: 1.3rem;">$<%= total.toFixed(2) %></span>
              </div>
              
              <div>
                <a href="/payment" style="display: block; width: 100%; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 1rem; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 1rem; text-align: center; margin-bottom: 0.75rem;">Proceed to Payment</a>
                <a href="/userdashboard" style="display: block; width: 100%; text-align: center; background: white; color: #666; border: 1px solid #ddd; padding: 0.75rem; border-radius: 8px; text-decoration: none; font-weight: 500;">Continue Shopping</a>
              </div>
            </section>
          </div>
        </div>
      <% } %>

    </main>
</div>

<%- include('partials/footer') %>

