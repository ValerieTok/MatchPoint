<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Feedback - MatchPoint</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="/css/user-common.css" />
    <link rel="stylesheet" href="/css/user-dashboard.css" />
    <link rel="stylesheet" href="/css/admin-feedback.css" />
  </head>
  <body class="admin-feedback">
    <div class="app">
      <aside class="sidebar">
        <div class="brand">
          <div class="brand__dot"><i class="fa-solid fa-bullseye"></i></div>
          <div class="brand__name">MatchPoint</div>
        </div>
        <nav class="nav">
          <a class="nav__item" href="/admindashboard"><i class="fa-regular fa-chart-bar"></i>Overview</a>
          <a class="nav__item" href="/admincoaches"><i class="fa-solid fa-user-tie"></i>Coaches</a>
          <a class="nav__item" href="/adminstudents"><i class="fa-solid fa-user-group"></i>Students</a>
          <a class="nav__item" href="/adminservices"><i class="fa-solid fa-layer-group"></i>Services</a>
          <a class="nav__item nav__item--active" href="/adminfeedback"><i class="fa-regular fa-message"></i>Feedback</a>
        </nav>
      </aside>

      <main class="main">
        <header class="topbar">
          <div class="crumb">ADMIN FEEDBACK</div>
          <div class="topbar__pill"><i class="fa-regular fa-message"></i></div>
        </header>

        <% const safeStats = stats || {}; %>
        <section class="hero">
          <div class="hero__left">
            <h1>
              Hello <span class="hero__name"><%= user?.username || (user?.email ? user.email.split('@')[0] : 'Admin') %></span>
              <span class="wave">ðŸ‘‹</span>,
            </h1>
            <div class="stats">
              <div class="stat">
                <div class="stat__icon"><i class="fa-solid fa-user-group"></i></div>
                <div class="stat__meta">
                  <div class="stat__label">Total Students</div>
                  <div class="stat__value"><%= (safeStats.totalStudents || 0).toLocaleString('en-US') %></div>
                </div>
              </div>
              <div class="stat">
                <div class="stat__icon"><i class="fa-solid fa-user-tie"></i></div>
                <div class="stat__meta">
                  <div class="stat__label">Total Coaches</div>
                  <div class="stat__value"><%= (safeStats.totalCoaches || 0).toLocaleString('en-US') %></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="card feedback-card">
          <% const rows = Array.isArray(feedback) ? feedback : []; %>
          <% const activeFilters = filters || {}; %>
          <% const pager = pagination || { page: 1, perPage: 6, totalReviews: rows.length, totalPages: 1 }; %>
          <% const buildQuery = (pageNum) => { %>
            <% const params = []; %>
            <% if (activeFilters.search) params.push(`search=${encodeURIComponent(activeFilters.search)}`); %>
            <% if (activeFilters.status) params.push(`status=${encodeURIComponent(activeFilters.status)}`); %>
            <% if (activeFilters.sort) params.push(`sort=${encodeURIComponent(activeFilters.sort)}`); %>
            <% params.push(`page=${pageNum}`); %>
            <% return params.join('&'); %>
          <% }; %>

          <div class="card__head">
            <div class="card__title">Recent Feedback</div>
            <div class="card__tools">
              <div class="search">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input id="feedbackSearch" type="search" placeholder="Search" value="<%= activeFilters.search || '' %>" />
              </div>
              <div class="sort">
                <span class="sort__label">STATUS:</span>
                <select class="sort__btn" id="feedbackStatus">
                  <option value="">All</option>
                  <option value="pending" <%= activeFilters.status === 'pending' ? 'selected' : '' %>>Pending</option>
                  <option value="approved" <%= activeFilters.status === 'approved' ? 'selected' : '' %>>Approved</option>
                  <option value="rejected" <%= activeFilters.status === 'rejected' ? 'selected' : '' %>>Rejected</option>
                </select>
              </div>
              <div class="sort">
                <span class="sort__label">SORT BY:</span>
                <select class="sort__btn" id="feedbackSort">
                  <option value="newest" <%= activeFilters.sort !== 'oldest' && activeFilters.sort !== 'highest' && activeFilters.sort !== 'lowest' ? 'selected' : '' %>>Newest</option>
                  <option value="oldest" <%= activeFilters.sort === 'oldest' ? 'selected' : '' %>>Oldest</option>
                  <option value="highest" <%= activeFilters.sort === 'highest' ? 'selected' : '' %>>Highest</option>
                  <option value="lowest" <%= activeFilters.sort === 'lowest' ? 'selected' : '' %>>Lowest</option>
                </select>
              </div>
            </div>
          </div>

          <% if (!rows.length) { %>
            <div class="feedback-empty">No feedback found.</div>
          <% } else { %>
            <div class="feedback-grid">
              <% rows.forEach(row => { %>
                <article class="feedback-item">
                  <div class="feedback-meta">
                    <div class="feedback-from">
                      From: <strong><%= row.student_name %></strong> (User)
                    </div>
                    <div class="feedback-to">
                      To: <strong><%= row.coach_name || 'Coach' %></strong>
                    </div>
                  </div>
                  <div class="feedback-session">
                    <div class="feedback-title"><%= row.listing_title || 'Coaching Session' %></div>
                    <div class="feedback-date">
                      <% const createdDate = row.created_at ? new Date(row.created_at) : null; %>
                      <%= createdDate && !Number.isNaN(createdDate.getTime()) ? createdDate.toLocaleDateString('en-GB', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }) : '' %>
                    </div>
                  </div>
                  <div class="feedback-rating">
                    <% const rating = Math.round(Number(row.rating || 0)); %>
                    <% for (let i = 1; i <= 5; i += 1) { %>
                      <span class="star <%= i <= rating ? 'filled' : '' %>">&#9733;</span>
                    <% } %>
                    <span class="score"><%= Number(row.rating || 0).toFixed(1) %></span>
                  </div>
                  <p class="feedback-comment"><%= row.comment || 'No comment provided.' %></p>
                  <div class="feedback-actions">
                    <span class="pill pill--<%= row.review_status %>"><%= String(row.review_status || 'pending').toUpperCase() %></span>
                    <div class="buttons">
                      <form method="post" action="/adminfeedback/<%= row.id %>/approve">
                        <button class="btn approve" type="submit">Approve</button>
                      </form>
                      <form method="post" action="/adminfeedback/<%= row.id %>/reject">
                        <button class="btn reject" type="submit">Reject</button>
                      </form>
                    </div>
                  </div>
                </article>
              <% }) %>
            </div>
          <% } %>

          <div class="card__foot">
            <% const startIndex = pager.totalReviews ? ((pager.page - 1) * pager.perPage + 1) : 0; %>
            <% const endIndex = Math.min(pager.page * pager.perPage, pager.totalReviews || 0); %>
            <div class="hint">Showing <%= startIndex %> to <%= endIndex %> of <%= pager.totalReviews %> reviews</div>
            <div class="pager">
              <% if (pager.totalPages > 1) { %>
                <% if (pager.page > 1) { %>
                  <a class="pager__btn" href="/adminfeedback?<%= buildQuery(pager.page - 1) %>"><i class="fa-solid fa-chevron-left"></i></a>
                <% } %>
                <% for (let p = 1; p <= pager.totalPages; p += 1) { %>
                  <a class="pager__num <%= p === pager.page ? 'pager__num--active' : '' %>" href="/adminfeedback?<%= buildQuery(p) %>"><%= p %></a>
                <% } %>
                <% if (pager.page < pager.totalPages) { %>
                  <a class="pager__btn" href="/adminfeedback?<%= buildQuery(pager.page + 1) %>"><i class="fa-solid fa-chevron-right"></i></a>
                <% } %>
              <% } else { %>
                <span class="pager__num pager__num--active">1</span>
              <% } %>
            </div>
          </div>
        </section>
      </main>
    </div>
    <script>
      const search = document.getElementById('feedbackSearch');
      const sort = document.getElementById('feedbackSort');
      const status = document.getElementById('feedbackStatus');

      const buildUrl = (params) => {
        const url = new URL(window.location.href);
        Object.keys(params).forEach((key) => {
          if (params[key]) {
            url.searchParams.set(key, params[key]);
          } else {
            url.searchParams.delete(key);
          }
        });
        return url.toString();
      };

      sort?.addEventListener('change', () => {
        window.location.href = buildUrl({ sort: sort.value, page: 1 });
      });

      status?.addEventListener('change', () => {
        window.location.href = buildUrl({ status: status.value, page: 1 });
      });

      search?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          const value = (search.value || '').trim().toLowerCase();
          window.location.href = buildUrl({ search: value, page: 1 });
        }
      });
    </script>
  </body>
</html>
